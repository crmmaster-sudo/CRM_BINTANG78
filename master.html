<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CRM MASTER - Management System</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#f8fafc; --card:#fff; --accent:#3b82f6; --muted:#64748b;
    --success:#10b981; --danger:#ef4444; --warning:#f59e0b;
    --info:#06b6d4; --secondary:#64748b; --dark:#1e293b;
    --sidebar-bg: #ffffff; /* Warna sidebar baru - putih */
    --sidebar-text: #374151; /* Warna teks sidebar */
    --sidebar-hover: #f3f4f6; /* Warna hover */
    --sidebar-active: #e5e7eb; /* Warna aktif */
    --sidebar-border: #e5e7eb; /* Warna border */
    --sidebar-accent: #3b82f6; /* Warna aksen biru */
  }
  *{box-sizing:border-box;font-family:'Inter', system-ui, sans-serif}
  body{margin:0;background:var(--bg);color:#1e293b; line-height:1.6}
  
  /* ==================== LOGIN SCREEN STYLING ==================== */
  .login-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
    padding: 20px;
  }
  
  .login-card {
    background: white;
    border-radius: 16px;
    padding: 40px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 420px;
    text-align: center;
  }
  
  .login-logo {
    margin-bottom: 24px;
  }
  
  .logo-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3b82f6, #1e40af);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
    color: white;
    font-weight: 700;
    font-size: 24px;
  }
  
  .login-title {
    font-size: 28px;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 8px 0;
  }
  
  .login-subtitle {
    color: #64748b;
    margin: 0 0 32px 0;
    font-size: 16px;
  }
  
  .login-form {
    text-align: left;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #374151;
    font-size: 14px;
  }
  
  .form-input {
    width: 100%;
    padding: 14px;
    border-radius: 10px;
    border: 1px solid #d1d5db;
    font-size: 16px;
    transition: all 0.2s;
  }
  
  .form-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  .login-btn {
    width: 100%;
    padding: 14px;
    border-radius: 10px;
    border: 0;
    background: linear-gradient(135deg, #3b82f6, #1e40af);
    color: white;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 8px;
  }
  
  .login-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
  }
  
  .login-btn:active {
    transform: translateY(0);
  }
  
  .login-info {
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 8px;
    padding: 16px;
    margin-top: 24px;
    text-align: center;
  }
  
  .info-title {
    font-weight: 600;
    color: #0369a1;
    margin-bottom: 4px;
  }
  
  .info-text {
    color: #64748b;
    font-size: 14px;
    margin: 0;
  }
  
  .login-msg {
    margin-top: 16px;
    padding: 12px;
    border-radius: 8px;
    text-align: center;
    font-size: 14px;
    display: none;
  }
  
  .login-msg.error {
    background: #fef2f2;
    color: #dc2626;
    border: 1px solid #fecaca;
  }
  
  .login-msg.success {
    background: #f0fdf4;
    color: #16a34a;
    border: 1px solid #bbf7d0;
  }
  
  /* ==================== SIDEBAR STYLING - Warna Cerah ==================== */
  .app-container {
    display: flex;
    min-height: 100vh;
  }
  
  .sidebar {
    width: 280px;
    background: var(--sidebar-bg);
    color: var(--sidebar-text);
    transition: all 0.3s ease;
    overflow-y: auto;
    height: 100vh;
    position: fixed;
    left: 0;
    top: 0;
    z-index: 1000;
    box-shadow: 2px 0 10px rgba(0,0,0,0.05);
    border-right: 1px solid var(--sidebar-border);
  }
  
  .sidebar.collapsed {
    width: 70px;
  }
  
  .sidebar-header {
    padding: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--sidebar-border);
    background: var(--sidebar-bg);
  }
  
  .logo-container {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .logo {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: linear-gradient(135deg, var(--sidebar-accent), #1e40af);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    flex-shrink: 0;
  }
  
  .logo-text {
    font-weight: 700;
    font-size: 18px;
    white-space: nowrap;
    overflow: hidden;
    color: var(--sidebar-text);
  }
  
  .sidebar.collapsed .logo-text {
    display: none;
  }
  
  .toggle-btn {
    background: none;
    border: none;
    color: var(--sidebar-text);
    cursor: pointer;
    font-size: 18px;
    padding: 5px;
    border-radius: 4px;
    transition: background 0.2s;
  }
  
  .toggle-btn:hover {
    background: var(--sidebar-hover);
  }
  
  .sidebar-menu {
    padding: 16px 0;
  }
  
  .menu-item {
    padding: 12px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--sidebar-text);
    text-decoration: none;
    transition: all 0.2s;
    border-left: 3px solid transparent;
  }
  
  .menu-item:hover {
    background: var(--sidebar-hover);
    color: var(--sidebar-text);
  }
  
  .menu-item.active {
    background: var(--sidebar-active);
    color: var(--sidebar-accent);
    border-left-color: var(--sidebar-accent);
    font-weight: 600;
  }
  
  .menu-icon {
    width: 20px;
    text-align: center;
    flex-shrink: 0;
    color: var(--sidebar-text);
  }
  
  .menu-item.active .menu-icon {
    color: var(--sidebar-accent);
  }
  
  .menu-text {
    white-space: nowrap;
    overflow: hidden;
  }
  
  .sidebar.collapsed .menu-text {
    display: none;
  }
  
  .main-content {
    flex: 1;
    margin-left: 280px;
    transition: margin-left 0.3s ease;
  }
  
  .main-content.expanded {
    margin-left: 70px;
  }
  
  /* ==================== HEADER STYLING ==================== */
  header {
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,.1);
    border-bottom: 1px solid #e2e8f0;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  
  .mobile-menu-btn {
    display: none;
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    border-radius: 4px;
    transition: background 0.2s;
    color: #374151;
  }
  
  .mobile-menu-btn:hover {
    background: #f1f5f9;
  }
  
  .header-title {
    display: flex;
    flex-direction: column;
  }
  
  .header-title h1 {
    margin: 0;
    font-size: 24px;
    color: #1e293b;
  }
  
  .header-subtitle {
    font-size: 14px;
    color: #64748b;
  }
  
  .user-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  /* ==================== CONTENT STYLING ==================== */
  .app {
    max-width: 1200px;
    margin: 24px auto;
    padding: 0 20px;
  }
  
  .card {
    background: var(--card);
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,.1);
    border: 1px solid #e2e8f0;
    margin-bottom: 20px;
  }
  
  input, select {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    margin-top: 6px;
    font-size: 14px;
  }
  
  /* ==================== TOMBOL DENGAN WARNA YANG LEBIH KONTRAST ==================== */
  button {
    padding: 10px 20px;
    border-radius: 8px;
    border: 0;
    background: var(--accent);
    color: #fff;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  button:hover {
    opacity: 0.9;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  
  button:active {
    transform: translateY(0);
  }
  
  button.danger {
    background: var(--danger);
    color: white;
  }
  
  button.success {
    background: var(--success);
    color: white;
  }
  
  button.warning {
    background: var(--warning);
    color: white;
  }
  
  button.info {
    background: var(--info);
    color: white;
  }
  
  button.secondary {
    background: var(--secondary);
    color: white;
  }
  
  button.dark {
    background: var(--dark);
    color: white;
  }
  
  /* Tombol kecil */
  .btn-sm {
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 600;
  }
  
  .cols {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-top: 24px;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    background: white;
  }
  
  th, td {
    padding: 12px;
    border-bottom: 1px solid #e2e8f0;
    text-align: left;
  }
  
  th {
    background: #f8fafc;
    font-weight: 600;
    color: #475569;
  }
  
  .muted {
    color: var(--muted);
    font-size: 13px;
  }
  
  .section-title {
    margin: 0 0 16px 0;
    font-size: 18px;
    font-weight: 600;
    color: #1e293b;
  }
  
  .subsection-title {
    margin: 16px 0 12px 0;
    font-size: 16px;
    font-weight: 600;
    color: #374151;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin: 20px 0;
  }
  
  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    text-align: center;
  }
  
  .stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #1e40af;
    margin: 8px 0;
  }
  
  .stat-label {
    font-size: 12px;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .form-group {
    margin-bottom: 16px;
  }
  
  .form-label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: #374151;
    font-size: 14px;
  }
  
  .action-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 16px;
  }
  
  .filter-bar {
    display: flex;
    gap: 12px;
    align-items: center;
    margin: 20px 0;
    padding: 16px;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
  }
  
  .admin-table {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #e2e8f0;
  }
  
  .badge {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .badge.leader {
    background: #dbeafe;
    color: #1e40af;
  }
  
  .badge.admin {
    background: #dcfce7;
    color: #166534;
  }
  
  .metric-value {
    font-weight: 600;
    color: #1e40af;
    font-size: 14px;
  }
  
  .metric-label {
    font-size: 11px;
    color: #64748b;
    text-transform: uppercase;
  }
  
  .import-status {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    color: #166534;
    padding: 12px;
    border-radius: 8px;
    margin-top: 12px;
    display: none;
  }
  
  .no-data {
    color: #94a3b8;
    font-style: italic;
  }
  
  .batch-info {
    background: #eff6ff;
    border: 1px solid #dbeafe;
    color: #1e40af;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    margin-top: 8px;
  }
  
  .batch-history {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 16px;
    margin-top: 16px;
    max-height: 300px;
    overflow-y: auto;
  }
  
  .batch-item {
    padding: 8px 12px;
    border-bottom: 1px solid #e2e8f0;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .batch-item:hover {
    background: #eff6ff;
  }
  
  .batch-item.active {
    background: #dbeafe;
    border-left: 3px solid #3b82f6;
  }
  
  .batch-info-small {
    font-size: 11px;
    color: #64748b;
  }
  
  .batch-count {
    background: #3b82f6;
    color: white;
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: bold;
  }
  
  .storage-warning {
    background: #fef3f2;
    border: 1px solid #fecaca;
    color: #dc2626;
    padding: 12px;
    border-radius: 8px;
    margin-top: 12px;
  }
  
  .storage-info {
    background: #eff6ff;
    border: 1px solid #dbeafe;
    color: #1e40af;
    padding: 12px;
    border-radius: 8px;
    margin-top: 12px;
  }

  /* CSS Baru untuk Tabel User & Performance */
  .user-table-group {
    margin-bottom: 16px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    overflow: hidden;
  }
  
  .user-group-header {
    background: #f8fafc;
    padding: 12px 16px;
    border-bottom: 1px solid #e2e8f0;
    font-weight: 600;
    color: #374151;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .user-group-count {
    font-size: 12px;
    color: #64748b;
    font-weight: normal;
  }
  
  .user-row {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid #e2e8f0;
    background: white;
  }
  
  .user-row:last-child {
    border-bottom: none;
  }
  
  .user-info {
    flex: 1;
  }
  
  .user-username {
    font-weight: 500;
    color: #1e293b;
    margin-bottom: 4px;
  }
  
  .user-created {
    font-size: 12px;
    color: #64748b;
  }
  
  .user-name {
    color: #374151;
    margin-bottom: 4px;
  }
  
  .user-role {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .user-role.leader {
    background: #dbeafe;
    color: #1e40af;
  }
  
  .user-role.admin {
    background: #dcfce7;
    color: #166534;
  }
  
  .user-metrics {
    display: flex;
    gap: 16px;
    margin-right: 16px;
  }
  
  .user-metric {
    text-align: center;
    min-width: 80px;
  }
  
  .user-metric-value {
    font-weight: 600;
    color: #1e40af;
    font-size: 14px;
    margin-bottom: 2px;
  }
  
  .user-metric-label {
    font-size: 11px;
    color: #64748b;
    text-transform: uppercase;
  }
  
  .user-actions {
    display: flex;
    gap: 8px;
  }
  
  .user-actions button {
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 600;
  }

  /* ==================== NAVIGASI TANGGAL BARU ==================== */
  .date-navigation {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    margin: 20px 0;
    padding: 16px;
    background: white;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .nav-btn {
    padding: 10px 16px;
    border: 1px solid #d1d5db;
    background: white;
    color: #374151;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .nav-btn:hover {
    background: #f8fafc;
    border-color: #9ca3af;
    transform: translateY(-1px);
  }

  .nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .current-date-display {
    font-size: 18px;
    font-weight: 600;
    color: #1e293b;
    min-width: 200px;
    text-align: center;
    padding: 8px 16px;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
  }

  .date-quick-nav {
    display: flex;
    gap: 8px;
    margin-left: 16px;
  }

  .quick-nav-btn {
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 600;
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    cursor: pointer;
    color: #374151;
  }

  .quick-nav-btn:hover {
    background: #e2e8f0;
    transform: translateY(-1px);
  }

  .comparison-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin: 20px 0;
  }

  .comparison-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  .comparison-title {
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 12px;
    text-align: center;
  }

  .comparison-value {
    font-size: 24px;
    font-weight: 700;
    text-align: center;
    margin: 8px 0;
  }

  .comparison-value.admin {
    color: #10b981;
  }

  .comparison-value.master {
    color: #1e293b;
  }

  .comparison-diff {
    text-align: center;
    font-size: 12px;
    color: #64748b;
    margin-top: 8px;
  }

  .diff-positive {
    color: #10b981;
    font-weight: 600;
  }

  .diff-negative {
    color: #ef4444;
    font-weight: 600;
  }

  .daily-breakdown {
    margin-top: 24px;
  }

  .breakdown-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .breakdown-table th,
  .breakdown-table td {
    padding: 10px;
    border-bottom: 1px solid #e2e8f0;
    text-align: left;
  }

  .breakdown-table th {
    background: #f8fafc;
    font-weight: 600;
    color: #475569;
  }

  .breakdown-table tr:hover {
    background: #f8fafc;
  }

  /* Data Source Tracking */
  .data-source-info {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: 8px;
    padding: 16px;
    margin: 16px 0;
  }

  .data-source-header {
    font-weight: 600;
    color: #166534;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .data-source-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 12px;
  }

  .data-source-stat {
    text-align: center;
    padding: 8px;
    background: white;
    border-radius: 6px;
    border: 1px solid #dcfce7;
  }

  .data-source-value {
    font-weight: 700;
    font-size: 16px;
    color: #166534;
    margin-bottom: 4px;
  }

  .data-source-label {
    font-size: 11px;
    color: #64748b;
    text-transform: uppercase;
  }

  /* ==================== STYLING BARU UNTUK TOTAL TRANSAKSI ==================== */
  .transaction-count {
    font-size: 32px;
    font-weight: 800;
    color: #10b981;
    margin: 12px 0;
    text-align: center;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }

  .transaction-label {
    font-size: 14px;
    color: #64748b;
    text-align: center;
    margin-bottom: 8px;
  }

  .transaction-subtitle {
    font-size: 12px;
    color: #94a3b8;
    text-align: center;
    margin-bottom: 12px;
  }

  /* Styling untuk Chart */
  .chart-container {
    position: relative;
    height: 400px;
    margin-top: 20px;
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border: 1px solid #e2e8f0;
  }

  /* Styling untuk card transaksi yang lebih menarik */
  .transaction-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    position: relative;
    overflow: hidden;
  }

  .transaction-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #10b981, #34d399);
  }

  /* ==================== STYLING BARU UNTUK FITUR APPROVAL DEPOSIT SESUAI SS ==================== */
  .approval-section {
    margin-top: 24px;
  }

  .approval-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .approval-title {
    font-size: 24px;
    font-weight: 700;
    color: #1e293b;
    margin: 0;
  }

  .approval-subtitle {
    font-size: 14px;
    color: #64748b;
    margin: 4px 0 0 0;
  }

  .approval-stats {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
  }

  .stat-card-approval {
    flex: 1;
    background: white;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .stat-card-approval:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .stat-card-approval.active {
    border-color: #3b82f6;
    background: #eff6ff;
  }

  .stat-value-approval {
    font-size: 28px;
    font-weight: 700;
    margin: 8px 0;
  }

  .stat-value-approval.pending {
    color: #f59e0b;
  }

  .stat-value-approval.approved {
    color: #10b981;
  }

  .stat-value-approval.rejected {
    color: #ef4444;
  }

  .stat-label-approval {
    font-size: 14px;
    color: #64748b;
    font-weight: 600;
  }

  .approval-filters {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    padding: 16px;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
  }

  .filter-select {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background: white;
    font-size: 14px;
  }

  .deposit-request-item {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    transition: all 0.2s;
  }

  .deposit-request-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }

  .request-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
  }

  .request-info {
    flex: 1;
  }

  .request-title {
    font-size: 16px;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 8px 0;
  }

  .request-meta {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
  }

  .request-meta-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: #64748b;
  }

  .request-status {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .status-pending {
    background: #fef3c7;
    color: #d97706;
  }

  .status-approved {
    background: #d1fae5;
    color: #065f46;
  }

  .status-rejected {
    background: #fee2e2;
    color: #dc2626;
  }

  .status-conflict {
    background: #fef3f2;
    color: #dc2626;
    border: 1px dashed #fecaca;
  }

  .request-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
    padding: 16px;
    background: #f8fafc;
    border-radius: 8px;
  }

  .detail-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #e2e8f0;
  }

  .detail-item:last-child {
    border-bottom: none;
  }

  .detail-label {
    font-size: 13px;
    color: #64748b;
  }

  .detail-value {
    font-size: 13px;
    font-weight: 600;
    color: #1e293b;
  }

  .request-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    border-top: 1px solid #f1f5f9;
    padding-top: 16px;
  }

  .proof-section {
    margin: 16px 0;
    padding: 16px;
    background: #f8fafc;
    border-radius: 8px;
  }

  .proof-title {
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
  }

  .proof-image {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    cursor: pointer;
    border: 1px solid #e2e8f0;
  }

  .proof-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .proof-modal img {
    max-width: 90%;
    max-height: 90%;
    border-radius: 8px;
  }

  .conflict-warning {
    background: #fef3f2;
    border: 1px solid #fecaca;
    color: #dc2626;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 16px;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .admin-selection {
    margin: 16px 0;
    padding: 16px;
    background: #eff6ff;
    border-radius: 8px;
  }

  .selection-title {
    font-size: 14px;
    font-weight: 600;
    color: #1e40af;
    margin-bottom: 12px;
  }

  .admin-option {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    padding: 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s;
    border: 1px solid #dbeafe;
  }

  .admin-option:hover {
    background: #dbeafe;
  }

  .admin-option.selected {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
  }

  .admin-option input {
    width: auto;
    margin: 0;
  }

  .admin-info {
    flex: 1;
  }

  .admin-name {
    font-weight: 600;
    margin-bottom: 4px;
  }

  .admin-time {
    font-size: 12px;
    color: inherit;
    opacity: 0.8;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #64748b;
  }

  .empty-icon {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .empty-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
    color: #374151;
  }

  .empty-subtitle {
    font-size: 14px;
    max-width: 400px;
    margin: 0 auto;
  }

  /* ==================== RESPONSIVE STYLING ==================== */
  @media (max-width: 1024px) {
    .sidebar {
      width: 240px;
    }
    
    .main-content {
      margin-left: 240px;
    }
    
    .main-content.expanded {
      margin-left: 70px;
    }
  }

  @media (max-width: 768px) {
    .sidebar {
      transform: translateX(-100%);
    }
    
    .sidebar.open {
      transform: translateX(0);
    }
    
    .main-content {
      margin-left: 0;
    }
    
    .mobile-menu-btn {
      display: block;
    }
    
    .cols {
      grid-template-columns: 1fr;
    }
    
    .comparison-stats {
      grid-template-columns: 1fr;
    }
    
    .approval-stats {
      flex-direction: column;
    }
    
    .request-details {
      grid-template-columns: 1fr;
    }
    
    .user-metrics {
      flex-direction: column;
      gap: 8px;
      margin-right: 8px;
    }
    
    .user-metric {
      min-width: 60px;
    }
  }

  @media (max-width: 480px) {
    .app {
      padding: 0 12px;
    }
    
    .card {
      padding: 16px;
    }
    
    .date-navigation {
      flex-direction: column;
      gap: 12px;
    }
    
    .date-quick-nav {
      margin-left: 0;
    }
    
    .approval-filters {
      flex-direction: column;
      align-items: stretch;
    }
    
    .filter-select {
      width: 100%;
    }
    
    .request-meta {
      flex-direction: column;
      gap: 8px;
    }
    
    .request-actions {
      flex-direction: column;
    }
    
    .request-actions button {
      width: 100%;
    }
  }
</style>
</head>
<body>
<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-container">
  <div class="login-card">
    <div class="login-logo">
      <div class="logo-circle">CM</div>
      <h1 class="login-title">CRM MASTER</h1>
      <p class="login-subtitle">Management System Login</p>
    </div>
    
    <div class="login-form">
      <div class="form-group">
        <label class="form-label">Username</label>
        <input type="text" id="loginUser" class="form-input" placeholder="Masukkan username" value="admin">
      </div>
      
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" id="loginPass" class="form-input" placeholder="Masukkan password" value="admin123">
      </div>
      
      <button type="button" onclick="doLogin()" class="login-btn">Login ke System</button>
      
      <div class="login-info">
        <div class="info-title">Default Login</div>
        <p class="info-text">Username: admin<br>Password: admin123</p>
      </div>
      
      <div id="loginMsg" class="login-msg"></div>
    </div>
  </div>
</div>

<!-- MAIN APPLICATION (HIDDEN INITIALLY) -->
<div id="mainApp" class="app-container" style="display:none">
  <!-- SIDEBAR NAVIGATION - Warna Cerah -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo-container">
        <div class="logo">CM</div>
        <div class="logo-text">CRM MASTER</div>
      </div>
      <button class="toggle-btn" id="sidebarToggle">‚ò∞</button>
    </div>
    
    <div class="sidebar-menu">
      <a href="#" class="menu-item active" data-section="dashboard">
        <span class="menu-icon">üìä</span>
        <span class="menu-text">Dashboard</span>
      </a>
      <a href="#" class="menu-item" data-section="management-user">
        <span class="menu-icon">üë•</span>
        <span class="menu-text">Management User</span>
      </a>
      <a href="#" class="menu-item" data-section="daftar-user">
        <span class="menu-icon">üìà</span>
        <span class="menu-text">Daftar User & Performance</span>
      </a>
      <a href="#" class="menu-item" data-section="import-data">
        <span class="menu-icon">üì§</span>
        <span class="menu-text">Import Data Member</span>
      </a>
      <a href="#" class="menu-item" data-section="generate-report">
        <span class="menu-icon">üìã</span>
        <span class="menu-text">Generate Report</span>
      </a>
      <a href="#" class="menu-item" data-section="approval-deposit">
        <span class="menu-icon">‚úÖ</span>
        <span class="menu-text">Approval Deposit Request</span>
      </a>
      <a href="#" class="menu-item" data-section="system-maintenance">
        <span class="menu-icon">üîß</span>
        <span class="menu-text">System Maintenance</span>
      </a>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content" id="mainContent">
    <header>
      <div style="display:flex;gap:12px;align-items:center">
        <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
        <div class="header-title">
          <h1 id="pageTitle">Management Dashboard</h1>
          <div class="header-subtitle" id="pageSubtitle">Monitor dan kelola seluruh data system</div>
        </div>
      </div>
      <div id="leaderSignedOut" style="display:none;align-items:center;gap:12px">
        <button type="button" onclick="showLogin()" class="info">Login</button>
      </div>
      <div id="leaderSignedIn" style="display:flex;align-items:center;gap:12px">
        <div class="muted" id="leaderName">Administrator</div>
        <button type="button" onclick="logout()" class="secondary">Logout</button>
      </div>
    </header>

    <div class="app">
      <!-- DASHBOARD -->
      <div id="mainUI">
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section-content">
          <!-- Header & Stats -->
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
              <div>
                <h1 style="margin:0;font-size:24px;color:#1e293b">Management Dashboard</h1>
                <div class="muted">Monitor dan kelola seluruh data system</div>
              </div>
              <div style="display:flex;gap:12px;align-items:center">
                <input type="date" id="fromDate" style="width:140px;padding:8px"/>
                <input type="date" id="toDate" style="width:140px;padding:8px"/>
                <button type="button" onclick="refreshAllData()" class="info">Terapkan Filter</button>
              </div>
            </div>

            <!-- NAVIGASI TANGGAL BARU -->
            <div class="date-navigation">
              <button class="nav-btn" onclick="navigateDate('prev')">
                ‚Üê Sebelumnya
              </button>
              
              <div class="current-date-display" id="currentDateDisplay">
                Loading...
              </div>
              
              <button class="nav-btn" onclick="navigateDate('next')" id="nextDateBtn">
                Berikutnya ‚Üí
              </button>

              <div class="date-quick-nav">
                <button class="quick-nav-btn" onclick="goToDate('today')">Hari Ini</button>
                <button class="quick-nav-btn" onclick="goToDate('yesterday')">Kemarin</button>
                <button class="quick-nav-btn" onclick="goToDate('week')">Minggu Ini</button>
              </div>
            </div>

            <!-- Statistics Cards -->
            <div class="stats-grid" id="adminStats">
              <div class="stat-card">
                <div class="stat-label">Total Admin</div>
                <div class="stat-value" id="totalAdmins">0</div>
                <div class="muted">User aktif</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Total Member</div>
                <div class="stat-value" id="totalMembers">0</div>
                <div class="muted">Data member</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Total Transaksi</div>
                <div class="stat-value" id="totalTransactions">0</div>
                <div class="muted">Deposit</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Total Pendapatan</div>
                <div class="stat-value" id="totalRevenue">Rp 0</div>
                <div class="muted">Keseluruhan</div>
              </div>
            </div>

            <!-- PERBANDINGAN HARIAN - BAGIAN YANG DIREVISI -->
            <div class="comparison-stats" id="dailyComparison" style="display:none">
              <div class="comparison-card">
                <div class="comparison-title">Pendapatan Admin (Harian)</div>
                <div class="comparison-value admin" id="adminDailyRevenue">Rp 0</div>
                <div class="muted" style="text-align:center">Total dari semua admin</div>
                <div class="comparison-diff" id="adminDailyDiff"></div>
              </div>
              <div class="comparison-card transaction-card">
                <div class="comparison-title">Total Transaksi Harian</div>
                <div class="transaction-count" id="dailyTransactionCount">0</div>
                <div class="transaction-subtitle">Seluruh Admin Hari Ini</div>
                <div class="comparison-diff" id="transactionDailyDiff"></div>
              </div>
            </div>

            <!-- BREAKDOWN HARIAN PER ADMIN - DIREVISI -->
            <div class="daily-breakdown" id="dailyBreakdown" style="display:none">
              <div class="subsection-title">Breakdown Harian per Admin</div>
              <div class="breakdown-table-container">
                <table class="breakdown-table">
                  <thead>
                    <tr>
                      <th>Admin</th>
                      <th>Jumlah Member</th>
                      <th>Jumlah Transaksi</th>
                      <th>Total Pendapatan</th>
                    </tr>
                  </thead>
                  <tbody id="breakdownTableBody">
                    <!-- Data akan diisi oleh JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Chart -->
            <div style="margin-top:24px">
              <div class="subsection-title" id="chartTitle">Grafik Pendapatan per Admin</div>
              <div class="chart-container">
                <canvas id="masterChart" height="400"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Management User Section -->
        <div id="management-user-section" class="section-content" style="display:none">
          <div class="card">
            <div class="section-title">Management User</div>
            <div class="muted" style="margin-bottom:16px">Tambah dan kelola user administrator</div>
            
            <div class="form-group">
              <label class="form-label">Username</label>
              <input id="newAdminUser" placeholder="username user baru"/>
            </div>
            
            <div class="form-group">
              <label class="form-label">Password</label>
              <input id="newAdminPass" placeholder="password"/>
            </div>
            
            <div class="form-group">
              <label class="form-label">Nama Lengkap</label>
              <input id="newAdminName" placeholder="nama lengkap"/>
            </div>
            
            <div class="form-group">
              <label class="form-label">Role</label>
              <select id="newAdminRole">
                <option value="admin">Admin</option>
                <option value="leader">Leader</option>
              </select>
            </div>
            
            <div class="action-buttons">
              <button type="button" onclick="addAdmin()" class="success">Tambah User</button>
              <button type="button" onclick="exportAllData()" class="secondary">Export Data</button>
            </div>
          </div>
        </div>

        <!-- Daftar User & Performance Section -->
        <div id="daftar-user-section" class="section-content" style="display:none">
          <div class="card">
            <div class="section-title">Daftar User & Performance</div>
            <div id="userListContainer">
              <!-- Daftar user akan di-generate di sini -->
            </div>
          </div>
        </div>

        <!-- Import Data Member Section -->
        <div id="import-data-section" class="section-content" style="display:none">
          <div class="card">
            <div class="section-title">Import Data Member</div>
            <div class="muted" style="margin-bottom:16px">Upload file Excel data member (kolom: ID, Nama, Phone, last_deposit)</div>
            
            <div class="form-group">
              <label class="form-label">File Excel</label>
              <input type="file" id="fileImport" accept=".xlsx,.xls,.csv" style="padding:8px"/>
              <div class="muted" style="margin-top:4px">Format: .xlsx, .xls, .csv</div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Tujuan Admin</label>
              <select id="assignAdmin">
                <option value="">Pilih admin tujuan</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Batch Import</label>
              <div class="batch-info">
                <strong>Batch ID Saat Ini:</strong> <span id="currentBatchId">-</span>
                <div style="margin-top:4px;font-size:11px">Setiap import akan memiliki batch ID unik untuk tracking</div>
              </div>
            </div>
            
            <div class="action-buttons">
              <button type="button" onclick="importToAdmin()" class="success">Import Data</button>
              <button type="button" onclick="downloadTemplate()" class="secondary">Download Template</button>
              <button type="button" onclick="generateNewBatch()" class="info">Batch Baru</button>
              <button type="button" onclick="showBatchHistory()" class="warning">Cek Batch</button>
            </div>

            <!-- Batch History Section -->
            <div id="batchHistorySection" style="display:none">
              <div class="subsection-title" style="margin-top:20px">History Batch Import</div>
              
              <!-- Filter controls untuk batch history -->
              <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
                <input type="date" id="batchFromDate" style="width:140px;padding:6px;font-size:12px">
                <input type="date" id="batchToDate" style="width:140px;padding:6px;font-size:12px">
                <button type="button" onclick="filterBatchByDate()" class="btn-sm info">Filter</button>
                <button type="button" onclick="refreshBatchHistory()" class="btn-sm secondary">Reset</button>
              </div>
              
              <div class="batch-history" id="batchHistoryList">
                <!-- Daftar batch akan muncul di sini -->
              </div>
              <div class="action-buttons" style="margin-top:12px">
                <button type="button" onclick="refreshBatchHistory()" class="btn-sm info">Refresh</button>
                <button type="button" onclick="hideBatchHistory()" class="btn-sm secondary">Tutup</button>
              </div>
            </div>

            <div id="importStatus" class="import-status">
              <div style="font-weight:600">Status Import:</div>
              <div id="importMessage">Sedang memproses...</div>
            </div>
          </div>
        </div>

        <!-- Generate Report Section -->
        <div id="generate-report-section" class="section-content" style="display:none">
          <div class="card">
            <div class="section-title">Generate Report</div>
            <div class="muted" style="margin-bottom:16px">Buat laporan data system</div>
            
            <div class="form-group">
              <label class="form-label">Tipe Report</label>
              <select id="reportType">
                <option value="database">Data Member</option>
                <option value="omset">Data Transaksi</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">User</label>
              <select id="reportAdmin">
                <option value="__all">Semua User</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">Periode</label>
              <select id="reportRange">
                <option value="daily">Harian</option>
                <option value="monthly">Bulanan</option>
                <option value="yearly">Tahunan</option>
              </select>
            </div>
            
            <div class="action-buttons">
              <button type="button" onclick="generateReport()" class="success">Download Report</button>
              <button type="button" onclick="refreshAllData()" class="info">Refresh Data</button>
            </div>
          </div>
        </div>

        <!-- System Maintenance Section -->
        <div id="system-maintenance-section" class="section-content" style="display:none">
          <div class="card">
            <div class="section-title">System Maintenance</div>
            <div class="muted" style="margin-bottom:16px">Kelola storage dan optimasi database</div>
            
            <div class="form-group">
              <label class="form-label">Storage Usage</label>
              <div class="batch-info">
                <strong>Estimated Usage:</strong> <span id="storageUsage">-</span>
                <div style="margin-top:4px;font-size:11px">
                  <span id="storagePercentage">0%</span> dari 500 MB Supabase Free Tier
                </div>
              </div>
            </div>

            <div id="storageWarning" class="storage-warning" style="display:none">
              <div style="font-weight:600">‚ö†Ô∏è Storage Warning</div>
              <div>Storage hampir penuh! Segera bersihkan data lama.</div>
            </div>

            <div id="storageInfo" class="storage-info" style="display:none">
              <div style="font-weight:600">üíæ Storage Info</div>
              <div>Storage usage dalam batas aman.</div>
            </div>
            
            <div class="action-buttons">
              <button type="button" onclick="checkStorageUsage()" class="warning">Cek Storage</button>
              <button type="button" onclick="cleanupOldData()" class="danger">Bersihkan Data Lama</button>
              <button type="button" onclick="exportAllBackups()" class="secondary">Export Backup</button>
            </div>

            <div class="form-group" style="margin-top:16px">
              <label class="form-label">Auto-Cleanup Settings</label>
              <div style="display:flex;gap:8px;align-items:center">
                <input type="checkbox" id="autoCleanup" checked>
                <label for="autoCleanup" style="font-size:13px">Hapus otomatis data > 6 bulan</label>
              </div>
              <div class="muted" style="margin-top:4px">Akan dijalankan setiap kali login</div>
            </div>
          </div>
        </div>

        <!-- Approval Deposit Section -->
        <div id="approval-deposit-section" class="section-content" style="display:none">
          <div class="card">
            <div class="approval-section">
              <div class="approval-header">
                <div>
                  <h2 class="approval-title">Approval Deposit Request</h2>
                  <p class="approval-subtitle">Kelola permintaan deposit dari semua admin</p>
                </div>
                <button type="button" onclick="loadPendingDeposits()" class="info">Refresh Requests</button>
              </div>

              <div class="approval-stats">
                <div class="stat-card-approval active" onclick="filterByStatus('pending')">
                  <div class="stat-value-approval pending" id="pendingCount">0</div>
                  <div class="stat-label-approval">MENUNGGU</div>
                </div>
                <div class="stat-card-approval" onclick="filterByStatus('approved')">
                  <div class="stat-value-approval approved" id="approvedCount">0</div>
                  <div class="stat-label-approval">DISETUJUI</div>
                </div>
                <div class="stat-card-approval" onclick="filterByStatus('rejected')">
                  <div class="stat-value-approval rejected" id="rejectedCount">0</div>
                  <div class="stat-label-approval">DITOLAK</div>
                </div>
              </div>

              <div class="approval-filters">
                <select class="filter-select" id="statusFilter" onchange="filterRequests()">
                  <option value="all">Semua Status</option>
                  <option value="pending">Menunggu</option>
                  <option value="approved">Disetujui</option>
                  <option value="rejected">Ditolak</option>
                </select>
                <select class="filter-select" id="adminFilter" onchange="filterRequests()">
                  <option value="all">Semua Admin</option>
                </select>
              </div>

              <div id="depositApprovalList">
                <!-- Daftar deposit yang perlu approval akan muncul di sini -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal untuk melihat bukti deposit -->
<div id="proofModal" class="proof-modal" style="display:none">
  <img id="proofModalImage" src="" alt="Bukti Deposit">
</div>

<script>
// ==================== KONFIGURASI SUPA BASE ====================
const SUPABASE_URL = 'https://qclwmenzzzgzrrjuznql.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjbHdtZW56enpnenJyanV6bnFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNzM5MTgsImV4cCI6MjA3NTk0OTkxOH0.Gye11m1kIvDqaKBdKWHFpX17vTdlQrRE5bODf8fwPW0';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let currentUser = null;
let currentBatchId = null;
let allDeposits = [];
let currentFilterStatus = 'pending';
let currentFilterAdmin = 'all';

// ==================== SIDEBAR NAVIGATION LOGIC ====================
document.addEventListener('DOMContentLoaded', function() {
  // Sidebar toggle functionality
  const sidebar = document.getElementById('sidebar');
  const sidebarToggle = document.getElementById('sidebarToggle');
  const mobileMenuBtn = document.getElementById('mobileMenuBtn');
  const mainContent = document.getElementById('mainContent');
  
  // Toggle sidebar collapse/expand
  sidebarToggle.addEventListener('click', function() {
    sidebar.classList.toggle('collapsed');
    mainContent.classList.toggle('expanded');
  });
  
  // Mobile menu toggle
  mobileMenuBtn.addEventListener('click', function() {
    sidebar.classList.toggle('open');
  });
  
  // Menu item click handling
  const menuItems = document.querySelectorAll('.menu-item');
  menuItems.forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Remove active class from all items
      menuItems.forEach(i => i.classList.remove('active'));
      
      // Add active class to clicked item
      this.classList.add('active');
      
      // Get the section to show
      const sectionId = this.getAttribute('data-section') + '-section';
      
      // Hide all sections
      document.querySelectorAll('.section-content').forEach(section => {
        section.style.display = 'none';
      });
      
      // Show the selected section
      document.getElementById(sectionId).style.display = 'block';
      
      // Update page title and subtitle
      updatePageTitle(this);
      
      // Close sidebar on mobile after selection
      if (window.innerWidth <= 768) {
        sidebar.classList.remove('open');
      }
    });
  });
  
  // Function to update page title based on selected menu
  function updatePageTitle(menuItem) {
    const pageTitle = document.getElementById('pageTitle');
    const pageSubtitle = document.getElementById('pageSubtitle');
    const menuText = menuItem.querySelector('.menu-text').textContent;
    
    pageTitle.textContent = menuText;
    
    // Set appropriate subtitles
    const subtitles = {
      'Dashboard': 'Monitor dan kelola seluruh data system',
      'Management User': 'Tambah dan kelola user administrator',
      'Daftar User & Performance': 'Lihat daftar user dan performa mereka',
      'Import Data Member': 'Upload data member dari Excel',
      'Generate Report': 'Buat laporan data system',
      'Approval Deposit Request': 'Kelola persetujuan deposit',
      'System Maintenance': 'Kelola storage dan optimasi database'
    };
    
    pageSubtitle.textContent = subtitles[menuText] || 'Management System';
  }
  
  // Close sidebar when clicking outside on mobile
  document.addEventListener('click', function(e) {
    if (window.innerWidth <= 768 && 
        !sidebar.contains(e.target) && 
        !mobileMenuBtn.contains(e.target) && 
        sidebar.classList.contains('open')) {
      sidebar.classList.remove('open');
    }
  });
});

// ==================== AUTHENTICATION ====================
async function doLogin() {
  const username = document.getElementById('loginUser').value.trim();
  const password = document.getElementById('loginPass').value;

  if (!username || !password) {
    showMessage('loginMsg', 'Username dan password harus diisi', 'error');
    return;
  }

  try {
    const { data: admins, error } = await supabase
      .from('admins')
      .select('*')
      .eq('username', username)
      .eq('password', password);

    if (error) throw error;

    if (admins && admins.length > 0) {
      currentUser = admins[0];
      showMessage('loginMsg', 'Login berhasil...', 'success');
      setTimeout(() => openMain(currentUser), 1000);
    } else {
      showMessage('loginMsg', 'Username atau password salah', 'error');
    }
  } catch (error) {
    console.error('Login error:', error);
    showMessage('loginMsg', 'Error koneksi database', 'error');
  }
}

function showLogin() {
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
}

function logout() {
  currentUser = null;
  localStorage.removeItem('currentMasterUser');
  showLogin();
}

function openMain(user) {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'flex';
  
  document.getElementById('leaderName').textContent = `${user.name} (${user.role})`;
  localStorage.setItem('currentMasterUser', JSON.stringify(user));
  
  generateNewBatch();
  updateDateDisplay();
  refreshAllData();
  loadDailyData();
  
  // Load deposit yang perlu approval
  setTimeout(() => {
    loadPendingDeposits();
    checkStorageUsage();
    autoCleanupOnLogin();
  }, 2000);
}

// ==================== VARIABEL NAVIGASI TANGGAL ====================
let currentViewDate = new Date(); // Tanggal yang sedang dilihat

// ==================== FUNGSI NAVIGASI TANGGAL ====================
function navigateDate(direction) {
  const newDate = new Date(currentViewDate);
  
  if (direction === 'prev') {
    newDate.setDate(newDate.getDate() - 1);
  } else if (direction === 'next') {
    newDate.setDate(newDate.getDate() + 1);
  }
  
  // Cek jika tanggal melebihi hari ini
  const today = new Date();
  today.setHours(23, 59, 59, 999);
  
  if (newDate > today) {
    showImportStatus('Tidak bisa melihat data masa depan', false);
    return;
  }
  
  currentViewDate = newDate;
  updateDateDisplay();
  loadDailyData();
  refreshCharts();
}

function goToDate(type) {
  const newDate = new Date();
  
  switch (type) {
    case 'today':
      currentViewDate = new Date();
      break;
    case 'yesterday':
      newDate.setDate(newDate.getDate() - 1);
      currentViewDate = newDate;
      break;
    case 'week':
      newDate.setDate(newDate.getDate() - 7);
      currentViewDate = newDate;
      break;
  }
  
  updateDateDisplay();
  loadDailyData();
  refreshCharts();
}

function updateDateDisplay() {
  const dateDisplay = document.getElementById('currentDateDisplay');
  const options = { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  };
  
  const formattedDate = currentViewDate.toLocaleDateString('id-ID', options);
  dateDisplay.textContent = formattedDate;
  
  // Update tombol next berdasarkan apakah tanggal adalah hari ini
  const today = new Date();
  const isToday = currentViewDate.toDateString() === today.toDateString();
  document.getElementById('nextDateBtn').disabled = isToday;
}

// ==================== LOAD DATA HARIAN DENGAN REVISI UNTUK TOTAL TRANSAKSI ====================
async function loadDailyData() {
  try {
    showImportStatus('Memuat data harian...', true);
    
    const dateStr = currentViewDate.toISOString().split('T')[0];
    const prevDate = new Date(currentViewDate);
    prevDate.setDate(prevDate.getDate() - 1);
    const prevDateStr = prevDate.toISOString().split('T')[0];
    
    // Load data untuk tanggal yang dipilih
    const { data: dailyDeposits, error: dailyError } = await supabase
      .from('deposits')
      .select('*')
      .eq('date', dateStr);
    
    if (dailyError) throw dailyError;
    
    // Load data untuk tanggal sebelumnya (untuk perbandingan)
    const { data: prevDeposits, error: prevError } = await supabase
      .from('deposits')
      .select('*')
      .eq('date', prevDateStr);
    
    if (prevError) throw prevError;
    
    // ==================== PERUBAHAN UTAMA: HITUNG JUMLAH TRANSAKSI ====================
    const todayTransactionCount = dailyDeposits ? dailyDeposits.length : 0;
    const prevTransactionCount = prevDeposits ? prevDeposits.length : 0;
    
    // Hitung revenue untuk bagian pertama (tetap tampilkan revenue admin)
    const adminRevenue = dailyDeposits ? dailyDeposits.reduce((sum, d) => sum + (d.amount || 0), 0) : 0;
    const prevAdminRevenue = prevDeposits ? prevDeposits.reduce((sum, d) => sum + (d.amount || 0), 0) : 0;
    
    // ==================== UPDATE UI DENGAN DATA TRANSAKSI ====================
    // Bagian pertama: Tetap tampilkan pendapatan admin
    document.getElementById('adminDailyRevenue').textContent = formatCurrency(adminRevenue);
    
    // Bagian kedua: Tampilkan jumlah transaksi (mengganti "Data Anda")
    document.getElementById('dailyTransactionCount').textContent = todayTransactionCount;
    
    // Hitung perbedaan
    const adminDiff = adminRevenue - prevAdminRevenue;
    const transactionDiff = todayTransactionCount - prevTransactionCount;
    
    // Tampilkan perbedaan pendapatan admin
    document.getElementById('adminDailyDiff').innerHTML = adminDiff !== 0 ? 
      `<span class="${adminDiff > 0 ? 'diff-positive' : 'diff-negative'}">${adminDiff > 0 ? '‚Üë' : '‚Üì'} ${formatCurrency(Math.abs(adminDiff))} dari kemarin</span>` :
      'Sama dengan kemarin';
    
    // Tampilkan perbedaan jumlah transaksi
    document.getElementById('transactionDailyDiff').innerHTML = transactionDiff !== 0 ? 
      `<span class="${transactionDiff > 0 ? 'diff-positive' : 'diff-negative'}">${transactionDiff > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(transactionDiff)} transaksi dari kemarin</span>` :
      'Sama dengan kemarin';
    
    // Tampilkan section perbandingan
    document.getElementById('dailyComparison').style.display = 'grid';
    
    // Load breakdown per admin
    await loadDailyBreakdown(dateStr, dailyDeposits);
    
    // PERBARUI GRAFIK
    await refreshCharts();
    
    showImportStatus(`Data harian ${dateStr} berhasil dimuat`, true);
    
  } catch (error) {
    console.error('Error loading daily data:', error);
    showImportStatus('Error memuat data harian', false);
  }
}

// ==================== LOAD BREAKDOWN HARIAN PER ADMIN - DIREVISI ====================
async function loadDailyBreakdown(dateStr, dailyDeposits) {
  try {
    // Get all admins
    const { data: admins, error: adminError } = await supabase
      .from('admins')
      .select('username')
      .eq('role', 'admin');
    
    if (adminError) throw adminError;
    
    const breakdownBody = document.getElementById('breakdownTableBody');
    breakdownBody.innerHTML = '';
    
    if (!admins || admins.length === 0) {
      breakdownBody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:20px;color:#666">Tidak ada data admin</td></tr>';
      document.getElementById('dailyBreakdown').style.display = 'none';
      return;
    }
    
    let hasData = false;
    
    for (const admin of admins) {
      // Filter deposits untuk admin ini
      const adminDeposits = dailyDeposits ? dailyDeposits.filter(d => d.admin_username === admin.username) : [];
      
      // Get member count untuk admin ini pada tanggal tersebut
      const { data: adminMembers, error: memberError } = await supabase
        .from('members')
        .select('id')
        .eq('admin_username', admin.username)
        .gte('created_at', dateStr + 'T00:00:00')
        .lte('created_at', dateStr + 'T23:59:59');
      
      if (memberError) throw memberError;
      
      const memberCount = adminMembers ? adminMembers.length : 0;
      const transactionCount = adminDeposits.length;
      const revenue = adminDeposits.reduce((sum, d) => sum + (d.amount || 0), 0);
      
      if (memberCount > 0 || transactionCount > 0) {
        hasData = true;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${admin.username}</strong></td>
          <td>${memberCount}</td>
          <td>${transactionCount}</td>
          <td>${formatCurrency(revenue)}</td>
        `;
        breakdownBody.appendChild(row);
      }
    }
    
    if (hasData) {
      document.getElementById('dailyBreakdown').style.display = 'block';
    } else {
      document.getElementById('dailyBreakdown').style.display = 'none';
      breakdownBody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:20px;color:#666">Tidak ada data untuk tanggal ini</td></tr>';
    }
    
  } catch (error) {
    console.error('Error loading daily breakdown:', error);
    document.getElementById('dailyBreakdown').style.display = 'none';
  }
}

// ==================== CHARTS YANG RESPONSIF TERHADAP TANGGAL ====================
let chartInstance = null;

async function refreshCharts() {
  try {
    // Gunakan tanggal dari navigasi tanggal, bukan dari filter date range
    const dateStr = currentViewDate.toISOString().split('T')[0];
    
    const { data: admins, error: adminError } = await supabase
      .from('admins')
      .select('username')
      .eq('role', 'admin');

    if (adminError) throw adminError;

    const adminLabels = admins ? admins.map(a => a.username) : [];
    const totals = [];

    if (adminLabels.length === 0) {
      const ctx = document.getElementById('masterChart').getContext('2d');
      if (chartInstance) chartInstance.destroy();
      
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Belum Ada Data'],
          datasets: [{
            label: 'Pendapatan',
            data: [0],
            backgroundColor: 'rgba(59, 130, 246, 0.7)'
          }]
        },
        options: {
          responsive: true,
          plugins: { 
            legend: { display: false },
            title: {
              display: true,
              text: `Tambah admin untuk melihat data - ${dateStr}`
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      return;
    }

    // Ambil data deposit untuk tanggal yang dipilih
    for (const admin of admins) {
      const { data: deposits, error: depositError } = await supabase
        .from('deposits')
        .select('amount')
        .eq('admin_username', admin.username)
        .eq('date', dateStr); // Filter berdasarkan tanggal yang dipilih

      if (depositError) throw depositError;

      const total = deposits ? deposits.reduce((sum, d) => sum + (d.amount || 0), 0) : 0;
      totals.push(total);
    }

    const ctx = document.getElementById('masterChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();

    // Array warna cerah untuk grafik
    const brightColors = [
      'rgba(59, 130, 246, 0.8)',   // Biru cerah
      'rgba(16, 185, 129, 0.8)',   // Hijau cerah (sama seperti pendapatan admin)
      'rgba(139, 92, 246, 0.8)',   // Ungu cerah
      'rgba(236, 72, 153, 0.8)',   // Pink cerah
      'rgba(14, 165, 233, 0.8)',   // Biru muda cerah
      'rgba(20, 184, 166, 0.8)',   // Cyan cerah
      'rgba(245, 158, 11, 0.8)',   // Oranye cerah
      'rgba(245, 101, 101, 0.8)'   // Merah cerah
    ];

    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: adminLabels,
        datasets: [{
          label: `Pendapatan - ${dateStr}`,
          data: totals,
          backgroundColor: adminLabels.map((_, index) => 
            brightColors[index % brightColors.length]
          ),
          borderColor: adminLabels.map((_, index) => 
            brightColors[index % brightColors.length].replace('0.8', '1')
          ),
          borderWidth: 2,
          borderRadius: 6,
          borderSkipped: false,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { 
            display: true,
            position: 'top',
          },
          title: {
            display: true,
            text: `Grafik Pendapatan per Admin - ${formatDisplayDate(currentViewDate)}`,
            font: {
              size: 16,
              weight: 'bold'
            },
            padding: {
              top: 10,
              bottom: 30
            }
          },
          tooltip: {
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            titleColor: '#1e293b',
            bodyColor: '#475569',
            borderColor: '#e2e8f0',
            borderWidth: 1,
            cornerRadius: 8,
            displayColors: true,
            callbacks: {
              label: function(context) {
                return `Pendapatan: ${formatCurrency(context.raw)}`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return 'Rp ' + value.toLocaleString();
              },
              font: {
                size: 11
              }
            },
            grid: {
              color: 'rgba(226, 232, 240, 0.5)'
            },
            title: {
              display: true,
              text: 'Jumlah Pendapatan',
              font: {
                size: 12,
                weight: 'bold'
              }
            }
          },
          x: {
            grid: {
              display: false
            },
            ticks: {
              font: {
                size: 11
              }
            },
            title: {
              display: true,
              text: 'Admin',
              font: {
                size: 12,
                weight: 'bold'
              }
            }
          }
        },
        animation: {
          duration: 1000,
          easing: 'easeInOutQuart'
        },
        interaction: {
          intersect: false,
          mode: 'index'
        }
      }
    });

    // Update judul grafik
    document.getElementById('chartTitle').textContent = 
      `Grafik Pendapatan per Admin - ${formatDisplayDate(currentViewDate)}`;

  } catch (error) {
    console.error('Error loading chart:', error);
    
    const ctx = document.getElementById('masterChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();
    
    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Error'],
        datasets: [{
          label: 'Error',
          data: [0],
          backgroundColor: 'rgba(239, 68, 68, 0.7)'
        }]
      },
      options: {
        responsive: true,
        plugins: { 
          legend: { display: false },
          title: {
            display: true,
            text: 'Error memuat data grafik'
          }
        }
      }
    });
  }
}

// Fungsi tambahan untuk format tanggal tampilan
function formatDisplayDate(date) {
  return date.toLocaleDateString('id-ID', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

// ==================== FUNGSI BARU UNTUK APPROVAL DEPOSIT ====================

// Fungsi untuk memuat deposit yang perlu approval
async function loadPendingDeposits() {
  try {
    showImportStatus('Memuat deposit yang perlu approval...', true);
    
    // Ambil semua deposit requests
    const { data: requests, error } = await supabase
      .from('deposit_requests')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) throw error;

    allDeposits = requests || [];
    
    // Update statistik
    updateDepositStats();
    
    // Update filter admin
    updateAdminFilter();
    
    // Tampilkan daftar deposit
    displayDepositApprovalList();
    
    showImportStatus(`Berhasil memuat ${allDeposits.length} permintaan deposit`, true);
    
  } catch (error) {
    console.error('Error loading pending deposits:', error);
    showImportStatus('Error memuat permintaan deposit', false);
  }
}

// Fungsi untuk memperbarui statistik deposit
function updateDepositStats() {
  const pendingCount = allDeposits.filter(d => d.status === 'pending').length;
  const approvedCount = allDeposits.filter(d => d.status === 'approved').length;
  const rejectedCount = allDeposits.filter(d => d.status === 'rejected').length;
  
  document.getElementById('pendingCount').textContent = pendingCount;
  document.getElementById('approvedCount').textContent = approvedCount;
  document.getElementById('rejectedCount').textContent = rejectedCount;
}

// Fungsi untuk memperbarui filter admin
function updateAdminFilter() {
  const adminFilter = document.getElementById('adminFilter');
  const admins = [...new Set(allDeposits.map(d => d.admin_username))];
  
  // Hapus opsi admin kecuali "Semua Admin"
  while (adminFilter.children.length > 1) {
    adminFilter.removeChild(adminFilter.lastChild);
  }
  
  // Tambahkan opsi admin
  admins.forEach(admin => {
    if (admin) {
      const option = document.createElement('option');
      option.value = admin;
      option.textContent = admin;
      adminFilter.appendChild(option);
    }
  });
}

// Fungsi untuk menampilkan daftar deposit yang perlu approval
function displayDepositApprovalList() {
  const container = document.getElementById('depositApprovalList');
  
  // Filter deposit berdasarkan status dan admin
  let filteredDeposits = allDeposits;
  
  if (currentFilterStatus !== 'all') {
    filteredDeposits = filteredDeposits.filter(d => d.status === currentFilterStatus);
  }
  
  if (currentFilterAdmin !== 'all') {
    filteredDeposits = filteredDeposits.filter(d => d.admin_username === currentFilterAdmin);
  }
  
  if (filteredDeposits.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üìã</div>
        <div class="empty-title">Belum Ada Permintaan</div>
        <div class="empty-subtitle">Tidak ada permintaan deposit yang menunggu approval</div>
      </div>
    `;
    return;
  }

  let html = '';
  
  filteredDeposits.forEach(request => {
    const statusClass = `status-${request.status}`;
    const statusText = getStatusText(request.status);
    
    html += `
      <div class="deposit-request-item" id="request-${request.id}">
        <div class="request-header">
          <div class="request-info">
            <div class="request-title">Deposit ${formatCurrency(request.amount || 0)}</div>
            <div class="request-meta">
              <div class="request-meta-item">
                <span>üë§ ${request.admin_username || '-'}</span>
              </div>
              <div class="request-meta-item">
                <span>üÜî ${request.member_id || '-'}</span>
              </div>
              <div class="request-meta-item">
                <span>üìÖ ${request.deposit_date || '-'}</span>
              </div>
              <div class="request-meta-item">
                <span>üïí ${new Date(request.created_at).toLocaleString('id-ID')}</span>
              </div>
            </div>
          </div>
          <div class="request-status ${statusClass}">${statusText}</div>
        </div>
        
        <div class="request-details">
          <div class="detail-item">
            <span class="detail-label">Jumlah Deposit</span>
            <span class="detail-value">${formatCurrency(request.amount || 0)}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Admin</span>
            <span class="detail-value">${request.admin_username || '-'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Member ID</span>
            <span class="detail-value">${request.member_id || '-'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Nama Member</span>
            <span class="detail-value">${request.member_name || '-'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Tanggal Deposit</span>
            <span class="detail-value">${request.deposit_date || '-'}</span>
          </div>
        </div>
        
        ${request.proof_image_url ? `
        <div class="proof-section">
          <div class="proof-title">Bukti Transfer</div>
          <img src="${request.proof_image_url}" alt="Bukti Deposit" class="proof-image" onclick="showProofModal('${request.proof_image_url}')">
        </div>
        ` : ''}
        
        ${request.status === 'pending' ? `
        <div class="request-actions">
          <button type="button" onclick="approveDepositRequest('${request.id}')" class="success btn-sm">Setujui</button>
          <button type="button" onclick="rejectDepositRequest('${request.id}')" class="danger btn-sm">Tolak</button>
          <button type="button" onclick="viewDepositRequestDetails('${request.id}')" class="info btn-sm">Detail</button>
        </div>
        ` : ''}
        
        ${request.status === 'approved' ? `
        <div class="request-actions">
          <span class="muted">Disetujui oleh ${request.approved_by} pada ${new Date(request.approved_at).toLocaleString('id-ID')}</span>
        </div>
        ` : ''}
        
        ${request.status === 'rejected' ? `
        <div class="request-actions">
          <span class="muted">Ditolak oleh ${request.approved_by} pada ${new Date(request.approved_at).toLocaleString('id-ID')}</span>
          ${request.rejection_reason ? `<div class="muted">Alasan: ${request.rejection_reason}</div>` : ''}
        </div>
        ` : ''}
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// Fungsi untuk mendapatkan teks status
function getStatusText(status) {
  const statusMap = {
    'pending': 'MENUNGGU',
    'approved': 'DISETUJUI',
    'rejected': 'DITOLAK'
  };
  return statusMap[status] || status;
}

// Fungsi untuk memfilter berdasarkan status
function filterByStatus(status) {
  currentFilterStatus = status;
  
  // Update active state pada stat cards
  document.querySelectorAll('.stat-card-approval').forEach(card => {
    card.classList.remove('active');
  });
  
  if (status === 'pending') {
    document.querySelectorAll('.stat-card-approval')[0].classList.add('active');
  } else if (status === 'approved') {
    document.querySelectorAll('.stat-card-approval')[1].classList.add('active');
  } else if (status === 'rejected') {
    document.querySelectorAll('.stat-card-approval')[2].classList.add('active');
  }
  
  // Update filter dropdown
  document.getElementById('statusFilter').value = status;
  
  // Tampilkan ulang daftar
  displayDepositApprovalList();
}

// Fungsi untuk memfilter requests
function filterRequests() {
  currentFilterStatus = document.getElementById('statusFilter').value;
  currentFilterAdmin = document.getElementById('adminFilter').value;
  displayDepositApprovalList();
}

// Fungsi untuk menyetujui deposit request
async function approveDepositRequest(requestId) {
  if (!confirm('Setujui deposit ini?')) return;
  
  try {
    // Update status request
    const { error: updateError } = await supabase
      .from('deposit_requests')
      .update({ 
        status: 'approved',
        approved_by: currentUser.username,
        approved_at: new Date().toISOString()
      })
      .eq('id', requestId);

    if (updateError) throw updateError;

    // Dapatkan data request yang sudah disetujui
    const { data: approvedRequest, error: fetchError } = await supabase
      .from('deposit_requests')
      .select('*')
      .eq('id', requestId)
      .single();

    if (fetchError) throw fetchError;

    // Tambahkan ke tabel deposits
    const depositData = {
      id: 'd' + uid(),
      member_id: approvedRequest.member_id,
      member_name: approvedRequest.member_name,
      amount: approvedRequest.amount,
      date: approvedRequest.deposit_date,
      admin_username: approvedRequest.admin_username,
      created_at: new Date().toISOString(),
      approved_by: currentUser.username,
      approved_at: approvedRequest.approved_at
    };

    const { error: depositError } = await supabase
      .from('deposits')
      .insert([depositData]);

    if (depositError) throw depositError;

    // Tandai request sudah ditambahkan ke deposits
    const { error: markError } = await supabase
      .from('deposit_requests')
      .update({ added_to_deposits: true })
      .eq('id', requestId);

    if (markError) throw markError;

    showImportStatus('Deposit berhasil disetujui dan ditambahkan', true);
    
    // Refresh tampilan
    await loadPendingDeposits();
    await refreshAllData();
    
  } catch (error) {
    console.error('Error approving deposit request:', error);
    showImportStatus('Error menyetujui deposit', false);
  }
}

// Fungsi untuk menolak deposit request
async function rejectDepositRequest(requestId) {
  const reason = prompt('Alasan penolakan:');
  if (reason === null) return;
  
  try {
    const { error } = await supabase
      .from('deposit_requests')
      .update({ 
        status: 'rejected',
        approved_by: currentUser.username,
        approved_at: new Date().toISOString(),
        rejection_reason: reason || 'Tidak ada alasan'
      })
      .eq('id', requestId);

    if (error) throw error;

    showImportStatus('Deposit berhasil ditolak', true);
    
    // Refresh tampilan
    await loadPendingDeposits();
    
  } catch (error) {
    console.error('Error rejecting deposit request:', error);
    showImportStatus('Error menolak deposit', false);
  }
}

// Fungsi untuk melihat detail deposit request
async function viewDepositRequestDetails(requestId) {
  try {
    const { data: request, error } = await supabase
      .from('deposit_requests')
      .select('*')
      .eq('id', requestId)
      .single();

    if (error) throw error;

    if (!request) {
      alert('Request tidak ditemukan');
      return;
    }

    let details = `
Detail Deposit Request:
- ID: ${request.id}
- Admin: ${request.admin_username}
- Member ID: ${request.member_id}
- Nama Member: ${request.member_name}
- Jumlah: ${formatCurrency(request.amount)}
- Tanggal: ${request.deposit_date}
- Status: ${request.status}
- Diajukan: ${new Date(request.created_at).toLocaleString('id-ID')}
    `;

    if (request.approved_by) {
      details += `\n- Disetujui/ditolak oleh: ${request.approved_by}`;
      details += `\n- Waktu: ${new Date(request.approved_at).toLocaleString('id-ID')}`;
    }

    if (request.rejection_reason) {
      details += `\n- Alasan penolakan: ${request.rejection_reason}`;
    }

    alert(details);
    
  } catch (error) {
    console.error('Error viewing deposit details:', error);
    alert('Error memuat detail deposit');
  }
}

// Fungsi untuk menampilkan modal bukti deposit
function showProofModal(imageUrl) {
  const modal = document.getElementById('proofModal');
  const modalImage = document.getElementById('proofModalImage');
  
  modalImage.src = imageUrl;
  modal.style.display = 'flex';
  
  // Tutup modal ketika diklik di luar gambar
  modal.onclick = function(e) {
    if (e.target === modal) {
      modal.style.display = 'none';
    }
  };
}

// ==================== FIXED TIMEZONE FUNCTIONS ====================
function getCurrentLocalDate() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function parseExcelDate(excelDate) {
  try {
    if (!excelDate) return generateRandomDate();
    
    if (typeof excelDate === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(excelDate)) {
      return excelDate;
    }

    if (excelDate instanceof Date) {
      if (!isNaN(excelDate.getTime())) {
        const year = excelDate.getFullYear();
        const month = String(excelDate.getMonth() + 1).padStart(2, '0');
        const day = String(excelDate.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }
    }

    if (typeof excelDate === 'number') {
      const excelEpoch = new Date(1899, 11, 30);
      const jsDate = new Date(excelEpoch.getTime() + (excelDate - 1) * 86400000);
      
      if (excelDate > 59) jsDate.setDate(jsDate.getDate() - 1);
      
      if (!isNaN(jsDate.getTime())) {
        const year = jsDate.getFullYear();
        const month = String(jsDate.getMonth() + 1).padStart(2, '0');
        const day = String(jsDate.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }
    }

    if (typeof excelDate === 'string') {
      const cleanDate = excelDate.toString().trim();
      const localDate = new Date(cleanDate);
      if (!isNaN(localDate.getTime())) {
        const year = localDate.getFullYear();
        const month = String(localDate.getMonth() + 1).padStart(2, '0');
        const day = String(localDate.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      const parts = cleanDate.split(/[/-]/);
      if (parts.length === 3) {
        let day, month, year;
        if (parts[0].length === 4) {
          year = parts[0]; month = parts[1]; day = parts[2];
        } else {
          day = parts[0]; month = parts[1]; year = parts[2];
        }
        month = month.padStart(2, '0');
        day = day.padStart(2, '0');
        if (year.length === 2) year = '20' + year;

        const parsedDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
        if (!isNaN(parsedDate.getTime())) {
          const finalYear = parsedDate.getFullYear();
          const finalMonth = String(parsedDate.getMonth() + 1).padStart(2, '0');
          finalDay = String(parsedDate.getDate()).padStart(2, '0');
          return `${finalYear}-${finalMonth}-${finalDay}`;
        }
      }
    }

    return generateRandomDate();
    
  } catch (error) {
    console.warn('Date parsing error, using random date:', error, excelDate);
    return generateRandomDate();
  }
}

function generateRandomDate() {
  const randomDays = Math.floor(Math.random() * 90);
  const randomDate = new Date();
  randomDate.setDate(randomDate.getDate() - randomDays);
  const year = randomDate.getFullYear();
  const month = String(randomDate.getMonth() + 1).padStart(2, '0');
  const day = String(randomDate.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// ==================== STORAGE MANAGEMENT FUNCTIONS ====================
async function checkStorageUsage() {
  try {
    showImportStatus('Mengecek usage storage...', true);
    
    const { count: memberCount, error: memberError } = await supabase
      .from('members')
      .select('*', { count: 'exact', head: true });
    if (memberError) throw memberError;

    const { count: depositCount, error: depositError } = await supabase
      .from('deposits')
      .select('*', { count: 'exact', head: true });
    if (depositError) throw depositError;

    const { count: adminCount, error: adminError } = await supabase
      .from('admins')
      .select('*', { count: 'exact', head: true });
    if (adminError) throw adminError;

    const { count: requestCount, error: requestError } = await supabase
      .from('deposit_requests')
      .select('*', { count: 'exact', head: true });
    if (requestError) throw requestError;

    const totalRecords = (memberCount || 0) + (depositCount || 0) + (adminCount || 0) + (requestCount || 0);
    const estimatedSizeKB = totalRecords * 1;
    const estimatedSizeMB = estimatedSizeKB / 1024;
    const percentageUsed = (estimatedSizeMB / 500) * 100;
    
    document.getElementById('storageUsage').textContent = `${estimatedSizeMB.toFixed(2)} MB`;
    document.getElementById('storagePercentage').textContent = `${percentageUsed.toFixed(1)}%`;
    
    const warningElement = document.getElementById('storageWarning');
    const infoElement = document.getElementById('storageInfo');
    
    if (percentageUsed > 80) {
      warningElement.style.display = 'block';
      infoElement.style.display = 'none';
      showImportStatus(`‚ö†Ô∏è Storage hampir penuh: ${percentageUsed.toFixed(1)}% digunakan!`, false);
    } else {
      warningElement.style.display = 'none';
      infoElement.style.display = 'block';
      showImportStatus(`‚úÖ Storage usage: ${percentageUsed.toFixed(1)}% - Aman`, true);
    }
    
  } catch (error) {
    console.error('Storage check error:', error);
    showImportStatus('Error mengecek storage', false);
  }
}

async function cleanupOldData() {
  if (!confirm('Hapus data member yang tidak ada deposit > 6 bulan?')) return;

  try {
    showImportStatus('Membersihkan data lama...', true);
    
    const sixMonthsAgo = new Date();
    sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
    const sixMonthsAgoStr = sixMonthsAgo.toISOString().slice(0, 10);
    
    const { data: oldMembers, error: findError } = await supabase
      .from('members')
      .select('id, name, last_deposit, batch_id')
      .lt('last_deposit', sixMonthsAgoStr);
    
    if (findError) throw findError;
    
    if (!oldMembers || oldMembers.length === 0) {
      showImportStatus('‚úÖ Tidak ada data lama untuk dibersihkan', true);
      return;
    }
    
    showImportStatus(`Membackup ${oldMembers.length} data lama...`, true);
    await exportBackup('old_members_backup', oldMembers);
    
    const { error: deleteError } = await supabase
      .from('members')
      .delete()
      .lt('last_deposit', sixMonthsAgoStr);
    
    if (deleteError) throw deleteError;
    
    showImportStatus(`‚úÖ Berhasil menghapus ${oldMembers.length} data lama`, true);
    await refreshAllData();
    await checkStorageUsage();
    
  } catch (error) {
    console.error('Cleanup error:', error);
    showImportStatus('Error membersihkan data lama', false);
  }
}

async function exportBackup(type, data) {
  try {
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Backup');
    XLSX.writeFile(wb, `backup_${type}_${new Date().toISOString().slice(0,10)}.xlsx`);
  } catch (error) {
    console.error('Backup error:', error);
  }
}

async function exportAllBackups() {
  try {
    showImportStatus('Membackup semua data...', true);
    
    const { data: members, error: membersError } = await supabase.from('members').select('*');
    if (membersError) throw membersError;
    
    const { data: deposits, error: depositsError } = await supabase.from('deposits').select('*');
    if (depositsError) throw depositsError;
    
    const { data: admins, error: adminsError } = await supabase.from('admins').select('*');
    if (adminsError) throw adminsError;
    
    const { data: requests, error: requestsError } = await supabase.from('deposit_requests').select('*');
    if (requestsError) throw requestsError;
    
    const wb = XLSX.utils.book_new();
    
    if (members && members.length > 0) {
      const wsMembers = XLSX.utils.json_to_sheet(members);
      XLSX.utils.book_append_sheet(wb, wsMembers, 'Members');
    }
    
    if (deposits && deposits.length > 0) {
      const wsDeposits = XLSX.utils.json_to_sheet(deposits);
      XLSX.utils.book_append_sheet(wb, wsDeposits, 'Deposits');
    }
    
    if (admins && admins.length > 0) {
      const wsAdmins = XLSX.utils.json_to_sheet(admins);
      XLSX.utils.book_append_sheet(wb, wsAdmins, 'Admins');
    }
    
    if (requests && requests.length > 0) {
      const wsRequests = XLSX.utils.json_to_sheet(requests);
      XLSX.utils.book_append_sheet(wb, wsRequests, 'Deposit_Requests');
    }
    
    XLSX.writeFile(wb, `full_backup_${new Date().toISOString().slice(0,10)}.xlsx`);
    showImportStatus('‚úÖ Backup semua data berhasil', true);
    
  } catch (error) {
    console.error('Backup error:', error);
    showImportStatus('Error membuat backup', false);
  }
}

async function autoCleanupOnLogin() {
  const autoCleanup = document.getElementById('autoCleanup').checked;
  if (!autoCleanup) return;
  
  try {
    const sixMonthsAgo = new Date();
    sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
    const sixMonthsAgoStr = sixMonthsAgo.toISOString().slice(0, 10);
    
    const { data: oldMembers, error } = await supabase
      .from('members')
      .select('id')
      .lt('last_deposit', sixMonthsAgoStr);
    
    if (error) throw error;
    
    if (oldMembers && oldMembers.length > 0) {
      console.log(`Auto-cleanup: Found ${oldMembers.length} old members`);
    }
    
  } catch (error) {
    console.error('Auto-cleanup error:', error);
  }
}

// ==================== UTILITY FUNCTIONS ====================
function uid() { 
  return 'id' + Math.random().toString(36).slice(2, 9); 
}

function generateBatchId() {
  return 'batch_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function formatCurrency(amount) {
  return new Intl.NumberFormat('id-ID', {
    style: 'currency',
    currency: 'IDR',
    minimumFractionDigits: 0
  }).format(amount);
}

function showMessage(elementId, message, type = 'error') {
  const element = document.getElementById(elementId);
  element.textContent = message;
  element.className = `login-msg ${type}`;
  element.style.display = 'block';
  setTimeout(() => element.style.display = 'none', 5000);
}

function showImportStatus(message, isSuccess = true) {
  const statusElement = document.getElementById('importStatus');
  const messageElement = document.getElementById('importMessage');
  
  messageElement.textContent = message;
  statusElement.style.display = 'block';
  statusElement.style.background = isSuccess ? '#f0fdf4' : '#fef2f2';
  statusElement.style.borderColor = isSuccess ? '#bbf7d0' : '#fecaca';
  statusElement.style.color = isSuccess ? '#166534' : '#dc2626';
  
  setTimeout(() => {
    statusElement.style.display = 'none';
  }, 5000);
}

// ==================== BATCH MANAGEMENT ====================
function generateNewBatch() {
  currentBatchId = generateBatchId();
  document.getElementById('currentBatchId').textContent = currentBatchId;
  showImportStatus(`Batch baru dibuat: ${currentBatchId}`, true);
}

function updateBatchDisplay() {
  document.getElementById('currentBatchId').textContent = currentBatchId || '-';
}

// ==================== BATCH HISTORY & CHECKING ====================
async function showBatchHistory() {
  document.getElementById('batchHistorySection').style.display = 'block';
  await refreshBatchHistory();
}

function hideBatchHistory() {
  document.getElementById('batchHistorySection').style.display = 'none';
}

async function refreshBatchHistory() {
  try {
    showImportStatus('Memuat history batch...', true);
    
    const { data: batches, error } = await supabase
      .from('members')
      .select('batch_id, created_at, admin_username, id')
      .not('batch_id', 'is', null)
      .order('created_at', { ascending: false });

    if (error) throw error;

    const batchGroups = {};
    batches.forEach(member => {
      if (member.batch_id) {
        if (!batchGroups[member.batch_id]) {
          batchGroups[member.batch_id] = {
            batch_id: member.batch_id,
            created_at: member.created_at,
            admin_username: member.admin_username,
            count: 0
          };
        }
        batchGroups[member.batch_id].count++;
      }
    });

    const batchList = Object.values(batchGroups);
    const batchHistoryList = document.getElementById('batchHistoryList');
    
    if (batchList.length === 0) {
      batchHistoryList.innerHTML = '<div style="text-align:center;padding:20px;color:#666">Belum ada data batch</div>';
      showImportStatus('Tidak ada data batch ditemukan', true);
      return;
    }

    batchList.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    batchHistoryList.innerHTML = '';
    
    batchList.forEach(batch => {
      const batchItem = document.createElement('div');
      batchItem.className = 'batch-item';
      if (batch.batch_id === currentBatchId) batchItem.classList.add('active');
      
      const batchDate = new Date(batch.created_at);
      const now = new Date();
      const isToday = batchDate.toDateString() === now.toDateString();
      
      batchItem.innerHTML = `
        <div>
          <div style="font-weight:500">${batch.batch_id}</div>
          <div class="batch-info-small">
            ${batchDate.toLocaleString('id-ID')} | 
            Admin: ${batch.admin_username || 'Unknown'}
            ${isToday ? ' <span style="color:#10b981;">(Hari Ini)</span>' : ''}
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="batch-count">${batch.count} member</span>
          <button onclick="viewBatchDetails('${batch.batch_id}')" style="padding:4px 8px;font-size:10px" class="btn-sm info">Detail</button>
          <button onclick="useThisBatch('${batch.batch_id}')" style="padding:4px 8px;font-size:10px" class="btn-sm success">Pakai</button>
        </div>
      `;
      
      batchHistoryList.appendChild(batchItem);
    });

    showImportStatus(`Ditemukan ${batchList.length} batch`, true);
    
  } catch (error) {
    console.error('Error loading batch history:', error);
    showImportStatus('Error memuat history batch: ' + error.message, false);
  }
}

async function filterBatchByDate() {
  const fromDate = document.getElementById('batchFromDate').value;
  const toDate = document.getElementById('batchToDate').value;
  
  try {
    showImportStatus('Memfilter batch berdasarkan tanggal...', true);
    
    let query = supabase
      .from('members')
      .select('batch_id, created_at, admin_username, id')
      .not('batch_id', 'is', null);

    if (fromDate) query = query.gte('created_at', fromDate + 'T00:00:00');
    if (toDate) query = query.lte('created_at', toDate + 'T23:59:59');

    const { data: batches, error } = await query.order('created_at', { ascending: false });

    if (error) throw error;

    const batchGroups = {};
    batches.forEach(member => {
      if (member.batch_id) {
        if (!batchGroups[member.batch_id]) {
          batchGroups[member.batch_id] = {
            batch_id: member.batch_id,
            created_at: member.created_at,
            admin_username: member.admin_username,
            count: 0
          };
        }
        batchGroups[member.batch_id].count++;
      }
    });

    const batchList = Object.values(batchGroups);
    const batchHistoryList = document.getElementById('batchHistoryList');
    
    if (batchList.length === 0) {
      batchHistoryList.innerHTML = '<div style="text-align:center;padding:20px;color:#666">Tidak ada batch pada periode yang dipilih</div>';
      showImportStatus('Tidak ada batch ditemukan untuk periode tersebut', true);
      return;
    }

    batchList.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    batchHistoryList.innerHTML = '';
    
    batchList.forEach(batch => {
      const batchItem = document.createElement('div');
      batchItem.className = 'batch-item';
      if (batch.batch_id === currentBatchId) batchItem.classList.add('active');
      
      batchItem.innerHTML = `
        <div>
          <div style="font-weight:500">${batch.batch_id}</div>
          <div class="batch-info-small">
            ${new Date(batch.created_at).toLocaleString('id-ID')} | 
            Admin: ${batch.admin_username || 'Unknown'}
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="batch-count">${batch.count} member</span>
          <button onclick="viewBatchDetails('${batch.batch_id}')" style="padding:4px 8px;font-size:10px" class="btn-sm info">Detail</button>
          <button onclick="useThisBatch('${batch.batch_id}')" style="padding:4px 8px;font-size:10px" class="btn-sm success">Pakai</button>
        </div>
      `;
      
      batchHistoryList.appendChild(batchItem);
    });

    const dateRangeText = fromDate && toDate ? ` dari ${fromDate} sampai ${toDate}` : '';
    showImportStatus(`Ditemukan ${batchList.length} batch${dateRangeText}`, true);
    
  } catch (error) {
    console.error('Error filtering batch history:', error);
    showImportStatus('Error memfilter batch: ' + error.message, false);
  }
}

async function viewBatchDetails(batchId) {
  try {
    const { data: members, error } = await supabase
      .from('members')
      .select('*')
      .eq('batch_id', batchId)
      .order('created_at', { ascending: false });

    if (error) throw error;

    const memberList = members.map(member => 
      `- ${member.name} (${member.id}) - ${new Date(member.created_at).toLocaleDateString('id-ID')}`
    ).join('\n');

    alert(`Detail Batch: ${batchId}\nTotal Member: ${members.length}\n\nDaftar Member:\n${memberList}`);
    
  } catch (error) {
    console.error('Error viewing batch details:', error);
    alert('Error memuat detail batch: ' + error.message);
  }
}

function useThisBatch(batchId) {
  currentBatchId = batchId;
  document.getElementById('currentBatchId').textContent = currentBatchId;
  showImportStatus(`Menggunakan batch: ${batchId}`, true);
  hideBatchHistory();
}

// ==================== USER MANAGEMENT ====================
async function refreshAdminTable() {
  try {
    const { data: admins, error } = await supabase
      .from('admins')
      .select('*')
      .order('role')
      .order('username');

    if (error) throw error;

    const container = document.getElementById('userListContainer');
    container.innerHTML = '';

    if (!admins || admins.length === 0) {
      container.innerHTML = '<div style="text-align:center;padding:20px;color:#666">Belum ada user</div>';
      return;
    }

    const leaders = admins.filter(admin => admin.role === 'leader');
    const adminUsers = admins.filter(admin => admin.role === 'admin');
    const adminPerformance = await getAdminPerformance();

    if (leaders.length > 0) {
      const leaderGroup = document.createElement('div');
      leaderGroup.className = 'user-table-group';
      
      const leaderHeader = document.createElement('div');
      leaderHeader.className = 'user-group-header';
      leaderHeader.innerHTML = `
        <span>Leaders</span>
        <span class="user-group-count">${leaders.length} user</span>
      `;
      leaderGroup.appendChild(leaderHeader);

      leaders.forEach(admin => {
        const userRow = document.createElement('div');
        userRow.className = 'user-row';
        
        userRow.innerHTML = `
          <div class="user-info">
            <div class="user-username">${admin.username}</div>
            <div class="user-created">Created: ${new Date(admin.created_at).toLocaleDateString('id-ID')}</div>
            <div class="user-name">${admin.name || '-'}</div>
            <span class="user-role leader">${admin.role}</span>
          </div>
          <div class="user-actions">
            <button onclick="resetPassword('${admin.username}')" class="btn-sm warning">Reset PW</button>
            ${admin.username !== currentUser.username ? 
              `<button class="danger btn-sm" onclick="deleteAdmin('${admin.username}')">Hapus</button>` : 
              ''}
          </div>
        `;
        leaderGroup.appendChild(userRow);
      });
      
      container.appendChild(leaderGroup);
    }

    if (adminUsers.length > 0) {
      const adminGroup = document.createElement('div');
      adminGroup.className = 'user-table-group';
      
      const adminHeader = document.createElement('div');
      adminHeader.className = 'user-group-header';
      adminHeader.innerHTML = `
        <span>Admins</span>
        <span class="user-group-count">${adminUsers.length} user</span>
      `;
      adminGroup.appendChild(adminHeader);

      adminUsers.forEach(admin => {
        const performance = adminPerformance[admin.username] || { 
          memberCount: 0, 
          transactionCount: 0, 
          revenue: 0 
        };

        const userRow = document.createElement('div');
        userRow.className = 'user-row';
        
        userRow.innerHTML = `
          <div class="user-info">
            <div class="user-username">${admin.username}</div>
            <div class="user-created">Created: ${new Date(admin.created_at).toLocaleDateString('id-ID')}</div>
            <div class="user-name">${admin.name || '-'}</div>
            <span class="user-role admin">${admin.role}</span>
          </div>
          <div class="user-metrics">
            <div class="user-metric">
              <div class="user-metric-value">${performance.memberCount}</div>
              <div class="user-metric-label">Member</div>
            </div>
            <div class="user-metric">
              <div class="user-metric-value">${performance.transactionCount}</div>
              <div class="user-metric-label">Transaksi</div>
            </div>
            <div class="user-metric">
              <div class="user-metric-value">${formatCurrency(performance.revenue)}</div>
              <div class="user-metric-label">Pendapatan</div>
            </div>
          </div>
          <div class="user-actions">
            <button onclick="resetPassword('${admin.username}')" class="btn-sm warning">Reset PW</button>
            <button class="danger btn-sm" onclick="deleteAdmin('${admin.username}')">Hapus</button>
          </div>
        `;
        adminGroup.appendChild(userRow);
      });
      
      container.appendChild(adminGroup);
    }

    document.getElementById('totalAdmins').textContent = admins.length;

  } catch (error) {
    console.error('Error:', error);
    const container = document.getElementById('userListContainer');
    container.innerHTML = '<div style="text-align:center;padding:20px;color:red">Error loading data</div>';
  }
}

async function getAdminPerformance() {
  const from = document.getElementById('fromDate').value;
  const to = document.getElementById('toDate').value;
  
  try {
    const { data: admins, error: adminError } = await supabase
      .from('admins')
      .select('username, role')
      .eq('role', 'admin');

    if (adminError) throw adminError;

    const performance = {};

    for (const admin of admins) {
      let memberQuery = supabase
        .from('members')
        .select('id', { count: 'exact' })
        .eq('admin_username', admin.username);

      const { count: memberCount, error: memberError } = await memberQuery;
      if (memberError) throw memberError;

      let depositQuery = supabase
        .from('deposits')
        .select('amount')
        .eq('admin_username', admin.username);

      if (from) depositQuery = depositQuery.gte('date', from);
      if (to) depositQuery = depositQuery.lte('date', to);

      const { data: deposits, error: depositError } = await depositQuery;
      if (depositError) throw depositError;

      const transactionCount = deposits ? deposits.length : 0;
      const revenue = deposits ? deposits.reduce((sum, d) => sum + (d.amount || 0), 0) : 0;

      performance[admin.username] = {
        memberCount: memberCount || 0,
        transactionCount: transactionCount,
        revenue: revenue
      };
    }

    return performance;

  } catch (error) {
    console.error('Error getting admin performance:', error);
    return {};
  }
}

async function addAdmin() {
  const username = document.getElementById('newAdminUser').value.trim();
  const password = document.getElementById('newAdminPass').value;
  const name = document.getElementById('newAdminName').value.trim();
  const role = document.getElementById('newAdminRole').value;

  if (!username || !password || !name) {
    alert('Username, password, dan nama harus diisi');
    return;
  }

  try {
    const { data: existing } = await supabase
      .from('admins')
      .select('username')
      .eq('username', username)
      .single();

    if (existing) {
      alert('Username sudah digunakan');
      return;
    }

    const { error } = await supabase
      .from('admins')
      .insert([{
        username,
        password,
        name,
        role
      }]);

    if (error) throw error;

    document.getElementById('newAdminUser').value = '';
    document.getElementById('newAdminPass').value = '';
    document.getElementById('newAdminName').value = '';

    refreshAdminTable();
    populateAdminSelects();
    alert('User berhasil ditambahkan');
  } catch (error) {
    console.error('Error:', error);
    alert('Error menambahkan user: ' + error.message);
  }
}

async function deleteAdmin(username) {
  if (!confirm(`Hapus user ${username}?`)) return;
  if (username === currentUser.username) {
    alert('Tidak bisa menghapus user yang sedang login');
    return;
  }

  try {
    const { error } = await supabase
      .from('admins')
      .delete()
      .eq('username', username);

    if (error) throw error;

    refreshAdminTable();
    populateAdminSelects();
    alert('User berhasil dihapus');
  } catch (error) {
    console.error('Error:', error);
    alert('Error menghapus user');
  }
}

async function resetPassword(username) {
  const newPassword = prompt(`Masukkan password baru untuk ${username}:`);
  if (!newPassword) return;

  try {
    const { error } = await supabase
      .from('admins')
      .update({ password: newPassword })
      .eq('username', username);

    if (error) throw error;

    alert('Password berhasil direset');
  } catch (error) {
    console.error('Error:', error);
    alert('Error reset password');
  }
}

// ==================== DATA MANAGEMENT ====================
async function populateAdminSelects() {
  try {
    const { data: admins, error } = await supabase
      .from('admins')
      .select('username, role')
      .order('username');

    if (error) throw error;

    const assignSelect = document.getElementById('assignAdmin');
    const reportSelect = document.getElementById('reportAdmin');

    assignSelect.innerHTML = '<option value="">Pilih admin tujuan</option>';
    reportSelect.innerHTML = '<option value="__all">Semua User</option>';

    admins.forEach(admin => {
      if (admin.role === 'admin') {
        assignSelect.innerHTML += `<option value="${admin.username}">${admin.username}</option>`;
      }
      reportSelect.innerHTML += `<option value="${admin.username}">${admin.username}</option>`;
    });
  } catch (error) {
    console.error('Error:', error);
  }
}

async function refreshStats() {
  try {
    const from = document.getElementById('fromDate').value;
    const to = document.getElementById('toDate').value;

    // Get total members (KESELURUHAN)
    const { data: members, error: membersError } = await supabase
      .from('members')
      .select('id');

    if (membersError) throw membersError;

    // Get total transactions and revenue with date filter (KESELURUHAN dalam range)
    let depositQuery = supabase.from('deposits').select('amount');
    
    if (from) depositQuery = depositQuery.gte('date', from);
    if (to) depositQuery = depositQuery.lte('date', to);

    const { data: deposits, error: depositsError } = await depositQuery;

    if (depositsError) throw depositsError;

    const totalMembers = members ? members.length : 0;
    const totalTransactions = deposits ? deposits.length : 0;
    const totalRevenue = deposits ? deposits.reduce((sum, d) => sum + (d.amount || 0), 0) : 0;

    document.getElementById('totalMembers').textContent = totalMembers.toLocaleString();
    document.getElementById('totalTransactions').textContent = totalTransactions.toLocaleString();
    document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);

  } catch (error) {
    console.error('Error refreshing stats:', error);
  }
}

// ==================== IMPORT FUNCTION ====================
async function importToAdmin() {
  const fileInput = document.getElementById('fileImport');
  const adminUsername = document.getElementById('assignAdmin').value;

  if (!fileInput.files.length) {
    showImportStatus('Pilih file Excel terlebih dahulu', false);
    return;
  }
  if (!adminUsername) {
    showImportStatus('Pilih admin tujuan', false);
    return;
  }

  if (!currentBatchId) generateNewBatch();

  const file = fileInput.files[0];
  const reader = new FileReader();

  reader.onload = async function(e) {
    try {
      showImportStatus('Sedang memproses file...', true);
      
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { 
        type: 'array', 
        cellDates: true,
        cellText: false 
      });
      
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(sheet, { 
        raw: false,
        defval: '' 
      });

      if (jsonData.length === 0) {
        showImportStatus('File Excel kosong atau format tidak sesuai', false);
        return;
      }

      showImportStatus(`Memproses ${jsonData.length} data...`, true);

      const membersToInsert = [];
      const errors = [];
      let successCount = 0;

      for (let i = 0; i < jsonData.length; i++) {
        const row = jsonData[i];
        try {
          const id = row.ID || row.Id || row.id || '';
          const nama = row.Nama || row.nama || row.Name || row.name || '';
          const phone = row.Phone || row.phone || row.HP || row.hp || row.Telp || row.telp || '';
          let lastDeposit = row.last_deposit || row['Last Deposit'] || row['last deposit'] || row.Tanggal || row.tanggal || '';

          if (!id && !nama) {
            errors.push(`Baris ${i + 2}: ID atau Nama harus diisi`);
            continue;
          }

          const memberId = `${currentBatchId}_${id || `M${Date.now()}${i}`}`;
          const memberName = nama || 'Unknown';
          
          if (!lastDeposit) {
            const randomDays = Math.floor(Math.random() * 90);
            const randomDate = new Date();
            randomDate.setDate(randomDate.getDate() - randomDays);
            const year = randomDate.getFullYear();
            const month = String(randomDate.getMonth() + 1).padStart(2, '0');
            const day = String(randomDate.getDate()).padStart(2, '0');
            lastDeposit = `${year}-${month}-${day}`;
          } else {
            lastDeposit = parseExcelDate(lastDeposit);
          }

          const depositDate = new Date(lastDeposit);
          if (isNaN(depositDate.getTime())) {
            errors.push(`Baris ${i + 2}: Format tanggal tidak valid - ${lastDeposit}`);
            continue;
          }

          membersToInsert.push({
            id: memberId,
            name: memberName,
            phone: phone,
            last_deposit: lastDeposit,
            admin_username: adminUsername,
            hp_valid: false,
            deposit_valid: false,
            has_response: false,
            created_at: new Date().toISOString(),
            batch_id: currentBatchId
          });

          successCount++;

        } catch (rowError) {
          errors.push(`Baris ${i + 2}: ${rowError.message}`);
        }
      }

      if (errors.length > 0) {
        console.warn('Import warnings:', errors);
        if (successCount > 0) {
          showImportStatus(`Berhasil memproses ${successCount} data, ${errors.length} error. Lihat console untuk detail.`, false);
        } else {
          showImportStatus(`Gagal import: ${errors[0]}`, false);
          return;
        }
      }

      if (membersToInsert.length === 0) {
        showImportStatus('Tidak ada data yang valid untuk diimport', false);
        return;
      }

      showImportStatus(`Menyimpan ${membersToInsert.length} data ke database...`, true);

      const batchSize = 50;
      let successfulImports = 0;

      for (let i = 0; i < membersToInsert.length; i += batchSize) {
        const batch = membersToInsert.slice(i, i + batchSize);
        
        const { error } = await supabase.from('members').insert(batch);

        if (error) {
          console.error('Batch insert error:', error);
          
          if (batch.length > 1) {
            showImportStatus(`Error batch, mencoba insert satu per satu...`, false);
            let singleSuccess = 0;
            
            for (const singleMember of batch) {
              try {
                const { error: singleError } = await supabase.from('members').insert([singleMember]);
                if (!singleError) singleSuccess++;
              } catch (singleErr) {
                console.error('Single insert error:', singleErr);
              }
            }
            successfulImports += singleSuccess;
          }
          
          throw new Error(`Error batch ${Math.floor(i/batchSize) + 1}: ${error.message}`);
        } else {
          successfulImports += batch.length;
        }

        showImportStatus(`Progress: ${successfulImports}/${membersToInsert.length} data...`, true);
      }

      fileInput.value = '';
      await refreshAllData();
      
      const finalMessage = errors.length > 0 
        ? `‚úÖ Berhasil mengimpor ${successfulImports} member ke ${adminUsername} (${errors.length} error)`
        : `‚úÖ Berhasil mengimpor ${successfulImports} member ke ${adminUsername}`;
      
      showImportStatus(finalMessage, true);
      generateNewBatch();
      await checkStorageUsage();
      
    } catch (error) {
      console.error('Import error:', error);
      showImportStatus(`‚ùå Error mengimpor data: ${error.message}`, false);
    }
  };

  reader.onerror = function() {
    showImportStatus('Error membaca file', false);
  };

  reader.readAsArrayBuffer(file);
}

function downloadTemplate() {
  const today = new Date();
  const dates = [
    getCurrentLocalDate(),
    new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10),
    new Date(today.getTime() - 15 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10),
    new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10)
  ];

  const templateData = [
    {
      'ID': 'M001',
      'Nama': 'Budi Santoso',
      'Phone': '08123456789',
      'last_deposit': dates[0]
    },
    {
      'ID': 'M002', 
      'Nama': 'Sari Indah',
      'Phone': '08129876543',
      'last_deposit': dates[1]
    },
    {
      'ID': 'M003',
      'Nama': 'Andi Wijaya',
      'Phone': '08111222333',
      'last_deposit': dates[2]
    },
    {
      'ID': 'M004',
      'Nama': 'Rina Melati',
      'Phone': '08144555666',
      'last_deposit': dates[3]
    }
  ];

  const ws = XLSX.utils.json_to_sheet(templateData);
  const wscols = [
    { wch: 10 }, { wch: 20 }, { wch: 15 }, { wch: 15 }
  ];
  ws['!cols'] = wscols;

  const range = XLSX.utils.decode_range(ws['!ref']);
  for (let C = range.s.c; C <= range.e.c; ++C) {
    const cell_address = XLSX.utils.encode_cell({ c: C, r: 0 });
    if (!ws[cell_address]) continue;
    ws[cell_address].s = {
      font: { bold: true },
      fill: { fgColor: { rgb: "FFE6E6FA" } }
    };
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Template Member');
  XLSX.writeFile(wb, 'template_import_member.xlsx');
}

// ==================== REPORTS & EXPORT ====================
async function generateReport() {
  const reportType = document.getElementById('reportType').value;
  const admin = document.getElementById('reportAdmin').value;
  const range = document.getElementById('reportRange').value;

  try {
    let data, fileName;

    if (reportType === 'database') {
      let query = supabase.from('members').select('*');
      if (admin !== '__all') query = query.eq('admin_username', admin);
      
      const { data: members, error } = await query;
      if (error) throw error;
      
      data = members || [];
      fileName = `report_member_${admin}_${new Date().toISOString().slice(0,10)}.xlsx`;
    } else {
      let query = supabase.from('deposits').select('*');
      if (admin !== '__all') query = query.eq('admin_username', admin);
      
      const { data: deposits, error } = await query;
      if (error) throw error;
      
      data = deposits || [];
      fileName = `report_transaksi_${admin}_${new Date().toISOString().slice(0,10)}.xlsx`;
    }

    if (data.length === 0) {
      alert('Tidak ada data untuk diexport');
      return;
    }

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Report');
    XLSX.writeFile(wb, fileName);
  } catch (error) {
    console.error('Error:', error);
    alert('Error generating report: ' + error.message);
  }
}

async function exportAllData() {
  try {
    const [admins, members, deposits, requests] = await Promise.all([
      supabase.from('admins').select('*'),
      supabase.from('members').select('*'),
      supabase.from('deposits').select('*'),
      supabase.from('deposit_requests').select('*')
    ]);

    const wb = XLSX.utils.book_new();
    
    if (admins.data && admins.data.length > 0) {
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(admins.data), 'Users');
    }
    if (members.data && members.data.length > 0) {
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(members.data), 'Members');
    }
    if (deposits.data && deposits.data.length > 0) {
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(deposits.data), 'Transactions');
    }
    if (requests.data && requests.data.length > 0) {
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(requests.data), 'Deposit_Requests');
    }

    XLSX.writeFile(wb, `crm_backup_${new Date().toISOString().slice(0,10)}.xlsx`);
  } catch (error) {
    console.error('Error:', error);
    alert('Error exporting data: ' + error.message);
  }
}

async function refreshAllData() {
  await refreshAdminTable();
  await refreshStats();
  await refreshCharts();
  await populateAdminSelects();
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
  const today = new Date();
  const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
  
  document.getElementById('fromDate').value = firstDay.toISOString().slice(0,10);
  document.getElementById('toDate').value = today.toISOString().slice(0,10);
  
  document.getElementById('batchFromDate').value = firstDay.toISOString().slice(0,10);
  document.getElementById('batchToDate').value = today.toISOString().slice(0,10);

  const savedUser = localStorage.getItem('currentMasterUser');
  if (savedUser) {
    try {
      currentUser = JSON.parse(savedUser);
      openMain(currentUser);
    } catch (e) {
      localStorage.removeItem('currentMasterUser');
    }
  }
});
</script>
</body>
</html>