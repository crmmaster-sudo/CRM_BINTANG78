<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CRM ADMIN</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#f3f8ff; --card:#fff; --accent:#3b82f6; --muted:#666;
    --success:#16a34a; --danger:#ef4444; --warning:#f59e0b;
    --sidebar-width: 250px; --header-height: 70px;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,sans-serif}
  body{margin:0;background:var(--bg);color:#1b1b1b}
  
  /* Layout dengan Sidebar */
  .app-container {
    display: flex;
    min-height: 100vh;
  }
  
  /* Sidebar Styles */
  .sidebar {
    width: var(--sidebar-width);
    background: #1e293b;
    color: white;
    position: fixed;
    height: 100vh;
    overflow-y: auto;
    transition: all 0.3s ease;
    z-index: 100;
  }
  
  .sidebar-header {
    padding: 20px;
    border-bottom: 1px solid #334155;
    text-align: center;
  }
  
  .sidebar-menu {
    padding: 16px 0;
  }
  
  .menu-item {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    color: #cbd5e1;
    text-decoration: none;
    transition: all 0.2s ease;
    cursor: pointer;
  }
  
  .menu-item:hover {
    background: #334155;
    color: white;
  }
  
  .menu-item.active {
    background: #3b82f6;
    color: white;
    border-right: 3px solid #1d4ed8;
  }
  
  .menu-icon {
    margin-right: 12px;
    font-size: 18px;
  }
  
  .menu-text {
    font-size: 14px;
    font-weight: 500;
  }
  
  .menu-divider {
    height: 1px;
    background: #334155;
    margin: 8px 0;
  }
  
  /* Main Content Area */
  .main-content {
    flex: 1;
    margin-left: var(--sidebar-width);
    padding: 20px;
    transition: all 0.3s ease;
  }
  
  /* Header */
  header {
    height: var(--header-height);
    padding: 0 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,.05);
    position: sticky;
    top: 0;
    z-index: 99;
  }
  
  /* Mobile Toggle Button */
  .sidebar-toggle {
    display: none;
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #1e293b;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .sidebar {
      transform: translateX(-100%);
    }
    
    .sidebar.open {
      transform: translateX(0);
    }
    
    .main-content {
      margin-left: 0;
    }
    
    .sidebar-toggle {
      display: block;
    }
    
    .app-container.sidebar-open .main-content {
      margin-left: 0;
    }
  }
  
  /* Login Page Styles */
  .login-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px;
  }
  
  .login-box {
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    padding: 40px;
    width: 100%;
    max-width: 400px;
  }
  
  .login-header {
    text-align: center;
    margin-bottom: 30px;
  }
  
  .login-header h2 {
    margin: 0 0 10px 0;
    color: #1e293b;
    font-size: 24px;
    font-weight: 700;
  }
  
  .login-header p {
    margin: 0;
    color: #64748b;
    font-size: 14px;
  }
  
  .login-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
  }
  
  .form-label {
    font-weight: 500;
    margin-bottom: 8px;
    color: #374151;
    font-size: 14px;
  }
  
  .form-input {
    padding: 12px 16px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.2s ease;
  }
  
  .form-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  .login-button {
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 10px;
  }
  
  .login-button:hover {
    background: #2563eb;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }
  
  .login-button:active {
    transform: translateY(0);
  }
  
  .login-message {
    text-align: center;
    margin-top: 16px;
    font-size: 14px;
    min-height: 20px;
  }
  
  .login-message.error {
    color: #ef4444;
  }
  
  .login-message.success {
    color: #16a34a;
  }
  
  /* Existing Styles (dengan sedikit penyesuaian) */
  .card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,.06);margin-bottom:20px}
  input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-top:6px;font-size:14px}
  
  /* ANIMASI TOMBOL SEDERHANA */
  button{
    padding:10px 16px;
    border-radius:8px;
    border:0;
    background:var(--accent);
    color:#fff;
    cursor:pointer;
    font-size:14px;
    font-weight:500;
    transition:all 0.2s ease;
    transform:translateY(0);
    box-shadow:0 2px 4px rgba(0,0,0,0.1);
    position:relative;
    overflow:hidden;
  }
  
  button:hover {
    transform:translateY(-1px);
    box-shadow:0 4px 8px rgba(0,0,0,0.15);
  }
  
  button:active {
    transform:translateY(0);
    box-shadow:0 1px 2px rgba(0,0,0,0.1);
  }
  
  /* Efek ripple sederhana */
  .ripple {
    position:absolute;
    border-radius:50%;
    background:rgba(255,255,255,0.4);
    transform:scale(0);
    animation:ripple 0.4s linear;
    pointer-events:none;
  }
  
  @keyframes ripple {
    to {
      transform:scale(3);
      opacity:0;
    }
  }
  
  button.danger{
    background:var(--danger);
  }
  button.success{
    background:var(--success);
  }
  button.warning{
    background:var(--warning);
  }
  button.info{
    background:#6b7280;
  }
  
  /* Animasi khusus untuk tombol reset */
  .reset-btn {
    position:relative;
    border:2px solid #dc2626;
  }
  
  /* Animasi untuk tombol download */
  .download-btn {
    background:var(--success);
    font-size:16px;
    padding:12px 24px;
  }

  /* Tombol Google Drive */
  .drive-btn {
    background:#4285f4;
    font-size:14px;
    padding:8px 16px;
    display:flex;
    align-items:center;
    gap:6px;
    transition:all 0.3s ease;
  }
  
  .drive-btn:disabled {
    background:#9ca3af;
    cursor:not-allowed;
    transform:none;
  }
  
  .cols{display:grid;grid-template-columns:1fr 380px;gap:20px;margin-top:20px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:12px 8px;border-bottom:1px solid #eee;text-align:left;vertical-align:middle}
  .badge{padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600}
  .aktif{background:#dcfce7;color:#166534}
  .normal{background:#fef9c3;color:#854d0e}
  .jarang{background:#fee2e2;color:#991b1b}
  .filter-bar{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0;align-items:center}
  .search-bar{display:flex;gap:8px;margin-bottom:16px;align-items:center}
  .summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:20px}
  .summary-card{text-align:center;background:#f9fafb;box-shadow:none;padding:20px}
  .summary-value{font-size:24px;font-weight:700;margin:8px 0}
  .summary-label{font-size:14px;color:#666;margin-bottom:4px}
  .chart-container{margin:20px 0;min-height:200px}
  input[type="checkbox"]{transform:scale(1.2);margin:0 4px}
  th{background:#f8fafc;font-weight:600;font-size:13px}
  .sheet-message{display:none; padding:12px; border-radius:8px; font-size:13px; text-align:center; margin-top:12px}
  .sheet-info{background:#eff6ff;border:1px solid #dbeafe;color:#1e40af;padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px}
  .manual-process{background:#fff7ed;border:1px solid #fdba74;color:#9a3412;padding:16px;border-radius:8px;margin:16px 0;font-size:14px;line-height:1.6}
  .manual-steps{background:#fffbeb;padding:12px;border-radius:6px;margin:12px 0}
  .date-info{background:#f0f9ff;border:1px solid #bae6fd;color:#0369a1;padding:8px 12px;border-radius:6px;font-size:12px;margin:8px 0}
  .chart-actions{display:flex;gap:8px;margin:10px 0;justify-content:center}
  .reset-section{background:#fef2f2;border:1px solid #fecaca;padding:16px;border-radius:8px;margin:16px 0}
  .reset-buttons{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .date-navigation{display:flex;align-items:center;gap:8px;background:#f8fafc;padding:6px 12px;border-radius:8px;border:1px solid #e2e8f0}
  .date-display{font-size:13px;font-weight:500;color:#475569;min-width:140px;text-align:center}
  .nav-btn{padding:6px;background:transparent;color:#64748b;border:1px solid #e2e8f0;border-radius:6px;cursor:pointer}
  .nav-btn:hover{background:#e2e8f0}
  .today-btn{padding:6px 10px;background:#3b82f6;color:white;border-radius:6px;font-size:12px;border:none}
  .empty-state{padding:40px;text-align:center;color:#666;background:#f9fafb}
  .empty-state-icon{font-size:24px;margin-bottom:8px}
  .empty-state-title{font-size:16px;margin-bottom:8px;font-weight:600}
  .empty-state-desc{font-size:14px;margin-bottom:4px}
  .empty-state-hint{font-size:12px;color:#9ca3af}
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center}
  .modal-content{background:white;padding:24px;border-radius:12px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
  
  /* Animasi sederhana untuk card */
  .card {
    animation:fadeIn 0.3s ease-out;
  }
  
  @keyframes fadeIn {
    from {
      opacity:0;
      transform:translateY(10px);
    }
    to {
      opacity:1;
      transform:translateY(0);
    }
  }

  /* Loading spinner */
  .spinner {
    border: 2px solid #f3f3f3;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    animation: spin 1s linear infinite;
    display: inline-block;
    margin-right: 8px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Drive Instructions */
  .drive-instructions {
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 8px;
    padding: 16px;
    margin: 12px 0;
    font-size: 13px;
    line-height: 1.5;
  }

  .drive-instructions h4 {
    margin: 0 0 8px 0;
    color: #0369a1;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .instruction-steps {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .instruction-step {
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }

  .step-number {
    background: #3b82f6;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    flex-shrink: 0;
  }

  /* Deposit Stats */
  .deposit-stats {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 12px;
    text-align: center;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 8px;
  }

  .stat-item {
    background: rgba(255,255,255,0.2);
    padding: 8px;
    border-radius: 6px;
    backdrop-filter: blur(10px);
  }

  .stat-value {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 2px;
  }

  .stat-label {
    font-size: 11px;
    opacity: 0.9;
  }

  /* Kelipatan badge */
  .kelipatan-badge {
    background: #7c3aed;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: bold;
  }

  /* Database Member Header */
  .member-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .member-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  /* Auto Save Status */
  .auto-save-status {
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 8px;
    padding: 12px;
    margin: 12px 0;
    font-size: 13px;
  }

  .status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
  }

  .status-success {
    background: #dcfce7;
    color: #166534;
    border: 1px solid #bbf7d0;
  }

  .status-warning {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fde68a;
  }

  .status-error {
    background: #fee2e2;
    color: #dc2626;
    border: 1px solid #fecaca;
  }

  /* Styles untuk sistem konfirmasi deposit */
  .request-stats {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
  }

  .stat-card {
    padding: 16px;
    border-radius: 8px;
    text-align: center;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
  }

  .stat-card.pending {
    background: #fffbeb;
    border-color: #fcd34d;
  }

  .stat-card.approved {
    background: #f0fdf4;
    border-color: #bbf7d0;
  }

  .stat-card.rejected {
    background: #fef2f2;
    border-color: #fecaca;
  }

  .stat-value {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 4px;
  }

  .stat-label {
    font-size: 12px;
    color: #64748b;
  }

  .requests-section {
    margin-bottom: 24px;
  }

  .requests-section h4 {
    margin-bottom: 12px;
    color: #374151;
    font-size: 16px;
  }

  .request-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.2s ease;
  }

  .request-card.pending {
    border-left: 4px solid #f59e0b;
  }

  .request-card.approved {
    border-left: 4px solid #10b981;
  }

  .request-card.rejected {
    border-left: 4px solid #ef4444;
  }

  .request-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .member-name {
    font-weight: 600;
    color: #1f2937;
  }

  .request-date {
    color: #6b7280;
    font-size: 12px;
  }

  .request-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .amount {
    font-weight: bold;
    color: #059669;
    font-size: 16px;
  }

  .proof-link {
    color: #3b82f6;
    text-decoration: none;
    font-size: 14px;
    padding: 4px 8px;
    border: 1px solid #dbeafe;
    border-radius: 4px;
    background: #eff6ff;
  }

  .proof-link:hover {
    background: #dbeafe;
  }

  .notes {
    margin-top: 8px;
    padding: 8px;
    background: #f8fafc;
    border-radius: 4px;
    font-size: 12px;
    color: #64748b;
  }

  .request-actions {
    display: flex;
    gap: 8px;
  }

  .status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
  }

  .status-badge.approved {
    background: #dcfce7;
    color: #166534;
  }

  .status-badge.rejected {
    background: #fee2e2;
    color: #dc2626;
  }

  .request-footer {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #f3f4f6;
    font-size: 11px;
    color: #9ca3af;
  }

  .proof-preview {
    max-width: 200px;
    max-height: 150px;
    border-radius: 8px;
    border: 2px solid #e5e7eb;
    cursor: pointer;
    transition: transform 0.2s ease;
  }

  .proof-preview:hover {
    transform: scale(1.05);
  }

  .file-input-wrapper {
    position: relative;
    display: inline-block;
    width: 100%;
  }

  .file-input-wrapper input[type="file"] {
    opacity: 0;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
  }

  .file-input-label {
    display: block;
    padding: 12px;
    background: #f8fafc;
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .file-input-label:hover {
    background: #f0f9ff;
    border-color: #3b82f6;
  }

  .file-input-label.has-file {
    background: #f0fdf4;
    border-color: #10b981;
  }

  .approved-deposits-badge {
    background: #10b981;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    margin-left: 8px;
  }
</style>
</head>
<body>
<!-- Login Page -->
<div id="loginPage" class="login-container">
  <div class="login-box">
    <div class="login-header">
      <h2>Login Admin</h2>
      <p>Masukkan kredensial Anda untuk mengakses sistem</p>
    </div>
    
    <div class="login-form">
      <div class="form-group">
        <label class="form-label">Username</label>
        <input type="text" id="loginUser" class="form-input" placeholder="Masukkan username">
      </div>
      
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" id="loginPass" class="form-input" placeholder="Masukkan password">
      </div>
      
      <button class="login-button" onclick="doLogin()">Masuk</button>
      
      <div id="loginMsg" class="login-message"></div>
    </div>
  </div>
</div>

<!-- Main App (akan ditampilkan setelah login berhasil) -->
<div id="mainApp" class="app-container" style="display:none">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div style="font-weight:700;font-size:18px">CRM ADMIN</div>
    </div>
    
    <div class="sidebar-menu">
      <div class="menu-item active" onclick="showSection('dashboard')">
        <span class="menu-icon">üìä</span>
        <span class="menu-text">Dashboard</span>
      </div>
      
      <div class="menu-divider"></div>
      
      <div class="menu-item" onclick="showSection('member-database')">
        <span class="menu-icon">üë•</span>
        <span class="menu-text">Database Member</span>
      </div>
      
      <div class="menu-item" onclick="showSection('add-deposit')">
        <span class="menu-icon">üí∞</span>
        <span class="menu-text">Tambah Deposit</span>
      </div>
      
      <div class="menu-item" onclick="showSection('deposit-status')">
        <span class="menu-icon">üìã</span>
        <span class="menu-text">Status Permintaan</span>
      </div>
      
      <div class="menu-item" onclick="showSection('deposit-history')">
        <span class="menu-icon">üìà</span>
        <span class="menu-text">Riwayat Deposit</span>
      </div>
      
      <div class="menu-divider"></div>
      
      <div class="menu-item" onclick="showSection('auto-save')">
        <span class="menu-icon">üìÅ</span>
        <span class="menu-text">Auto Save ke Drive</span>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <header>
      <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
      <div style="display:flex;align-items:center;gap:12px">
        <!-- Date Navigation -->
        <div class="date-navigation">
          <button class="nav-btn" onclick="goToPreviousDay()">‚óÄ</button>
          <div id="currentDateDisplay" class="date-display">-</div>
          <button class="nav-btn" onclick="goToNextDay()">‚ñ∂</button>
          <button class="today-btn" onclick="goToToday()">Hari Ini</button>
        </div>
      </div>
      <div id="signedIn" style="display:none;align-items:center;gap:12px">
        <div id="adminName"></div>
        <button onclick="logout()">Logout</button>
      </div>
    </header>

    <!-- MAIN CONTENT SECTIONS -->
    <div id="mainUI">
      <!-- Dashboard Section -->
      <div id="dashboard-section" class="section">
        <!-- Dashboard Pendapatan -->
        <div class="card">
          <h3 style="margin-bottom:16px">Dashboard Pendapatan</h3>
          
          <div class="filter-bar">
            <input type="date" id="fromDate" style="width:150px"/>
            <input type="date" id="toDate" style="width:150px"/>
            <button onclick="refreshChart()">Terapkan Filter</button>
            <button onclick="showAllHistoricalData()" class="info">Lihat Semua Data</button>
            <button onclick="searchDepositByDate()" class="warning">Cari Tanggal</button>
            <button onclick="importFromMaster()">Terima dari Master</button>
          </div>

          <div class="date-info" id="dateRangeInfo">
            Menampilkan semua data historis
          </div>

          <div class="chart-container">
            <canvas id="omsetChart" height="150"></canvas>
          </div>

          <div class="chart-actions">
            <button onclick="showMonthlyView()" class="info">Tampilan Bulanan</button>
            <button onclick="showWeeklyView()" class="info">Tampilan Mingguan</button>
            <button onclick="showDailyView()" class="info">Tampilan Harian</button>
          </div>
          
          <div class="summary-grid">
            <div class="card summary-card">
              <div class="summary-label" id="totalDepositLabel">Total Jumlah Deposit</div>
              <div id="totalDepositToday" class="summary-value" style="color:#3b82f6;">Rp 0</div>
              <small id="summaryDate" style="color:#666;">Semua waktu</small>
            </div>
            <div class="card summary-card">
              <div class="summary-label" id="totalMemberLabel">Total Member Deposit</div>
              <div id="totalMemberToday" class="summary-value" style="color:#16a34a;">0 Member</div>
              <small style="color:#666;" id="memberDepositDesc">Melakukan deposit</small>
            </div>
          </div>

          <!-- RESET DATA SECTION -->
          <div class="reset-section">
            <h4 style="margin:0 0 12px 0;color:#dc2626">‚ö†Ô∏è Reset Data Admin</h4>
            <p style="margin:0 0 12px 0;font-size:14px;color:#7f1d1d">
              Hati-hati! Tindakan reset data tidak dapat dibatalkan. Pilih opsi reset sesuai kebutuhan:
            </p>
            <div class="reset-buttons">
              <button class="danger reset-btn" onclick="showResetMemberModal()">üë• Reset Member per Tanggal</button>
              <button class="danger reset-btn" onclick="resetAdminData()">üí• Reset Semua Data</button>
            </div>
            <small style="color:#7f1d1d;display:block;margin-top:8px">
              ‚Ä¢ Reset Member per Tanggal: Hanya hapus data MEMBER pada tanggal tertentu (deposit tetap)<br>
              ‚Ä¢ Reset Semua: Hapus SEMUA data admin (semua member + semua deposit)
            </small>
          </div>
        </div>
      </div>

      <!-- Database Member Section -->
      <div id="member-database-section" class="section" style="display:none">
        <div class="card">
          <div class="member-header">
            <h3 style="margin:0">Database Member</h3>
            <div class="member-actions">
              <button onclick="autoSaveMemberToGoogleDrive()" class="drive-btn" id="autoSaveMemberBtn">
                <span id="autoSaveMemberIcon">üìÅ</span>
                <span id="autoSaveMemberText">Auto Save Member ke Drive</span>
              </button>
              <button onclick="refreshMembers()" class="info">Refresh</button>
            </div>
          </div>
          
          <p id="memberCount" style="font-weight:600;color:#555;margin-bottom:16px">Total data: 0 member</p>

          <!-- Auto Save Status -->
          <div id="memberAutoSaveStatus" class="auto-save-status" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <strong>Status Auto Save:</strong>
                <span id="memberSaveStatusText" class="status-indicator status-warning">Belum disimpan hari ini</span>
              </div>
              <small id="lastSaveTime">-</small>
            </div>
            <div id="memberSaveStats" style="margin-top:8px; font-size:12px;"></div>
          </div>
          
          <div class="search-bar">
            <input id="searchMember" placeholder="Cari ID/Nama..." oninput="refreshMembers()" 
                   style="padding:10px 12px;width:250px;border:1px solid #ddd;border-radius:8px">
            <select id="statusFilter" onchange="refreshMembers()" 
                    style="padding:10px 12px;width:150px;border:1px solid #ddd;border-radius:8px">
              <option value="">Semua Status</option>
              <option value="aktif">Aktif</option>
              <option value="normal">Normal</option>
              <option value="jarang">Jarang</option>
            </select>
          </div>

          <div style="overflow-x:auto; border:1px solid #eee; border-radius:8px;">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nama</th>
                  <th>HP</th>
                  <th>Last Deposit</th>
                  <th>Status</th>
                  <th>HP Valid</th>
                  <th>No HP Tidak Valid</th>
                  <th>Sudah Deposit</th>
                  <th>Belum Deposit</th>
                  <th>Ada Respon</th>
                  <th>Tidak Respon</th>
                </tr>
              </thead>
              <tbody id="memberTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Tambah Deposit Section -->
      <div id="add-deposit-section" class="section" style="display:none">
        <div class="card">
          <h3 style="margin-bottom:16px">Tambah Deposit <span class="approved-deposits-badge" id="approvedDepositsCount">0 Disetujui</span></h3>
          
          <div class="form-group">
            <label class="form-label">Pilih Member</label>
            <select id="depositMember" style="padding:10px">
              <option value="">-- pilih --</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Atau Nama Manual</label>
            <input id="depositManual" placeholder="Nama luar database" style="padding:10px"/>
          </div>
          
          <div class="form-group">
            <label class="form-label">Nominal</label>
            <input id="depositAmount" type="text" placeholder="100000" style="padding:10px"/>
          </div>

          <div class="form-group">
            <label class="form-label">Tanggal Deposit</label>
            <input type="date" id="depositDate" style="padding:10px"/>
            <small style="color:#666;">Kosongkan untuk tanggal hari ini</small>
          </div>

          <!-- Field Upload Bukti Deposit -->
          <div class="form-group">
            <label class="form-label">Bukti Deposit <span style="color:#ef4444">*</span></label>
            <div class="file-input-wrapper">
              <input type="file" id="depositProof" accept="image/*,.pdf,.doc,.docx" style="padding:10px"/>
              <label for="depositProof" class="file-input-label" id="fileInputLabel">
                üìé Klik untuk upload bukti transfer<br>
                <small style="color:#666;">Format: JPG, PNG, PDF (Max 5MB)</small>
              </label>
            </div>
            <div id="proofPreview" style="margin-top:8px; display:none;">
              <img id="proofImagePreview" class="proof-preview" onclick="showProofModal(this.src)"/>
              <div id="proofFileName" style="margin-top:4px; font-size:12px; color:#666;"></div>
            </div>
          </div>
          
          <button onclick="submitDepositForApproval()" style="width:100%;padding:12px" class="success">üì§ Ajukan ke Master</button>
          <small style="color:#666; display:block; margin-top:8px; text-align:center;">
            Deposit akan diproses setelah disetujui CRM Master
          </small>
        </div>
      </div>

      <!-- Status Permintaan Deposit Section -->
      <div id="deposit-status-section" class="section" style="display:none">
        <div class="card">
          <h3 style="margin-bottom:16px">Status Permintaan Deposit</h3>
          <div id="depositRequestsContainer">
            <!-- Daftar permintaan akan dimuat di sini -->
            <div class="empty-state">
              <div class="empty-state-icon">üìã</div>
              <div class="empty-state-title">Belum Ada Permintaan</div>
              <div class="empty-state-desc">Ajukan deposit baru untuk melihat statusnya di sini</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Riwayat Deposit Section -->
      <div id="deposit-history-section" class="section" style="display:none">
        <div class="card">
          <h4 style="margin-bottom:16px">Riwayat Deposit Disetujui</h4>
          
          <div class="search-bar">
            <input id="searchDeposit" placeholder="Cari nama/nominal..." oninput="refreshDeposits()" 
                   style="padding:8px 12px;width:200px;border:1px solid #ddd;border-radius:8px">
            <button onclick="refreshDeposits()" class="info">Refresh</button>
          </div>
          
          <div style="overflow-x:auto; border:1px solid #eee; border-radius:8px;">
            <table>
              <thead>
                <tr>
                  <th>Tgl</th>
                  <th>Member</th>
                  <th>Jumlah</th>
                  <th>Tipe</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="depositTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Auto Save ke Drive Section -->
      <div id="auto-save-section" class="section" style="display:none">
        <!-- Google Drive Auto Save -->
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
            <h3 style="margin:0">üìÅ Auto Save ke Google Drive</h3>
            <button onclick="autoSaveToGoogleDrive()" class="drive-btn" id="autoSaveBtn">
              <span id="autoSaveIcon">‚òÅÔ∏è</span>
              <span id="autoSaveText">Auto Save ke Drive</span>
            </button>
          </div>

          <!-- Deposit Stats -->
          <div id="depositStats" class="deposit-stats">
            <div style="font-size:14px; opacity:0.9;">üìä Statistik Deposit Hari Ini</div>
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-value" id="todayDepositCount">0</div>
                <div class="stat-label">Transaksi</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="todayDepositTotal">Rp 0</div>
                <div class="stat-label">Total Deposit</div>
              </div>
            </div>
          </div>

          <!-- Instructions -->
          <div class="drive-instructions">
            <h4>üìã Cara Simpan ke Google Drive:</h4>
            <div class="instruction-steps">
              <div class="instruction-step">
                <div class="step-number">1</div>
                <div>Klik tombol <strong>"Auto Save ke Drive"</strong> di atas</div>
              </div>
              <div class="instruction-step">
                <div class="step-number">2</div>
                <div>File Excel akan otomatis terdownload</div>
              </div>
              <div class="instruction-step">
                <div class="step-number">3</div>
                <div>Buka <strong>drive.google.com</strong> di tab baru</div>
              </div>
              <div class="instruction-step">
                <div class="step-number">4</div>
                <div>Upload file yang sudah didownload</div>
              </div>
              <div class="instruction-step">
                <div class="step-number">5</div>
                <div>Data Anda sudah aman di cloud! üéâ</div>
              </div>
            </div>
          </div>

          <div style="color:#666; font-size:13px; line-height:1.5; margin-top:12px">
            <strong>‚ú® Format Data yang Disimpan:</strong><br>
            ‚Ä¢ <strong>Tanggal</strong> - Tanggal transaksi deposit<br>
            ‚Ä¢ <strong>ID Member</strong> - ID member dari database<br>
            ‚Ä¢ <strong>Jumlah Deposit</strong> - Nominal deposit<br>
            ‚Ä¢ <strong>Kelipatan Deposit</strong> - Jumlah transaksi dengan nominal sama<br>
            ‚Ä¢ <strong>Tipe</strong> - Database atau Manual
          </div>
          
          <div id="sheetMessage" class="sheet-message"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Reset Member -->
<div id="resetMemberModal" class="modal">
  <div class="modal-content">
    <h3 style="color:#dc2626; margin-bottom:16px;">üë• Reset Member per Tanggal</h3>
    
    <div class="form-group">
      <label class="form-label">Tanggal yang akan direset (YYYY-MM-DD)</label>
      <input type="date" id="resetDateInput" style="padding:10px; border:1px solid #e5e7eb; border-radius:8px"/>
      <small style="color:#666;">Pilih tanggal data member yang ingin dihapus</small>
    </div>

    <div id="resetPreview" style="display:none; background:#f8fafc; padding:12px; border-radius:8px; margin:12px 0;">
      <h4 style="margin:0 0 8px 0;">Preview Data yang Akan Dihapus:</h4>
      <div id="resetPreviewContent"></div>
    </div>

    <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px;">
      <button onclick="closeResetModal()" style="padding:8px 16px; border:1px solid #d1d5db; background:white; border-radius:6px; cursor:pointer;">
        Batal
      </button>
      <button onclick="confirmResetMember()" id="confirmResetBtn" style="padding:8px 16px; background:#dc2626; color:white; border:none; border-radius:6px; cursor:pointer; display:none;">
        Hapus Data Member
      </button>
      <button onclick="previewResetData()" style="padding:8px 16px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer;">
        Preview Data
      </button>
    </div>
  </div>
</div>

<!-- Modal Preview Bukti -->
<div id="proofModal" class="modal">
  <div class="modal-content" style="max-width:90%; max-height:90%;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h3 style="margin:0">Preview Bukti Deposit</h3>
      <button onclick="closeProofModal()" style="background:#6b7280; padding:8px 12px;">‚úï Tutup</button>
    </div>
    <img id="modalProofImage" style="max-width:100%; max-height:70vh; margin:0 auto; display:block; border-radius:8px;"/>
  </div>
</div>

<script>
// ==================== KONFIGURASI SUPA BASE ====================
const SUPABASE_URL = 'https://qclwmenzzzgzrrjuznql.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjbHdtZW56enpnenJyanV6bnFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNzM5MTgsImV4cCI6MjA3NTk0OTkxOH0.Gye11m1kIvDqaKBdKWHFpX17vTdlQrRE5bODf8fwPW0';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let currentAdmin = null;
let currentResetDate = null;
let previewMembers = [];

// ==================== FUNGSI SIDEBAR ====================
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.toggle('open');
}

function showSection(sectionName) {
  // Sembunyikan semua section
  const sections = document.querySelectorAll('.section');
  sections.forEach(section => {
    section.style.display = 'none';
  });
  
  // Tampilkan section yang dipilih
  document.getElementById(`${sectionName}-section`).style.display = 'block';
  
  // Update menu aktif
  const menuItems = document.querySelectorAll('.menu-item');
  menuItems.forEach(item => {
    item.classList.remove('active');
  });
  
  // Set menu item yang sesuai sebagai aktif
  const activeMenuItem = Array.from(menuItems).find(item => {
    return item.getAttribute('onclick') === `showSection('${sectionName}')`;
  });
  
  if (activeMenuItem) {
    activeMenuItem.classList.add('active');
  }
  
  // Tutup sidebar di mobile
  if (window.innerWidth <= 768) {
    toggleSidebar();
  }
}

// ==================== FUNGSI LOGIN ====================
async function doLogin() {
  const username = document.getElementById('loginUser').value.trim();
  const password = document.getElementById('loginPass').value;
  const messageElement = document.getElementById('loginMsg');

  // Reset message
  messageElement.textContent = '';
  messageElement.className = 'login-message';

  // Validasi input
  if (!username || !password) {
    messageElement.textContent = 'Username dan password harus diisi';
    messageElement.className = 'login-message error';
    return;
  }

  try {
    const { data: admins, error } = await supabase
      .from('admins')
      .select('*')
      .eq('username', username)
      .eq('password', password);

    if (error) throw error;

    if (admins && admins.length > 0) {
      currentAdmin = admins[0];
      messageElement.textContent = 'Login berhasil!';
      messageElement.className = 'login-message success';
      
      // Tunggu sebentar lalu buka main app
      setTimeout(() => openMain(currentAdmin), 1000);
    } else {
      messageElement.textContent = 'Username atau password salah';
      messageElement.className = 'login-message error';
    }
  } catch (error) {
    console.error('Login error:', error);
    messageElement.textContent = 'Terjadi kesalahan saat login';
    messageElement.className = 'login-message error';
  }
}

function showLogin() {
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('signedIn').style.display = 'none';
}

function logout() {
  currentAdmin = null;
  localStorage.removeItem('currentAdminUser');
  showLogin();
}

async function openMain(user) {
  // Sembunyikan halaman login, tampilkan main app
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('mainApp').style.display = 'flex';
  document.getElementById('signedIn').style.display = 'flex';
  document.getElementById('adminName').textContent = user.name;

  localStorage.setItem('currentAdminUser', JSON.stringify(user));
  
  initializeDailySystem();
  await loadAdminData();
  
  // Start polling untuk deposit requests
  startDepositRequestsPolling();
}

// ==================== FUNGSI ANIMASI RIPPLE SEDERHANA ====================
function createRipple(event) {
  const button = event.currentTarget;
  const circle = document.createElement("span");
  const diameter = Math.max(button.clientWidth, button.clientHeight);
  const radius = diameter / 2;

  circle.style.width = circle.style.height = `${diameter}px`;
  circle.style.left = `${event.clientX - button.getBoundingClientRect().left - radius}px`;
  circle.style.top = `${event.clientY - button.getBoundingClientRect().top - radius}px`;
  circle.classList.add("ripple");

  // Hapus ripple sebelumnya
  const ripple = button.getElementsByClassName("ripple")[0];
  if (ripple) {
    ripple.remove();
  }

  button.appendChild(circle);
}

// Tambahkan event listener untuk semua tombol
document.addEventListener('DOMContentLoaded', function() {
  const buttons = document.querySelectorAll('button');
  buttons.forEach(button => {
    button.addEventListener('click', createRipple);
  });

  // Event listener untuk preview file
  const proofInput = document.getElementById('depositProof');
  const fileInputLabel = document.getElementById('fileInputLabel');
  const proofPreview = document.getElementById('proofPreview');
  const proofImagePreview = document.getElementById('proofImagePreview');
  const proofFileName = document.getElementById('proofFileName');

  proofInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      // Validasi ukuran file (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Ukuran file terlalu besar! Maksimal 5MB.');
        proofInput.value = '';
        return;
      }

      // Validasi tipe file
      const validTypes = ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'];
      if (!validTypes.includes(file.type)) {
        alert('Format file tidak didukung! Gunakan JPG, PNG, atau PDF.');
        proofInput.value = '';
        return;
      }

      fileInputLabel.classList.add('has-file');
      fileInputLabel.innerHTML = `‚úÖ ${file.name}<br><small style="color:#666;">Klik untuk ganti file</small>`;
      
      proofFileName.textContent = `File: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`;
      
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          proofImagePreview.src = e.target.result;
          proofPreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        proofPreview.style.display = 'block';
        proofImagePreview.src = 'https://cdn-icons-png.flaticon.com/512/337/337946.png';
        proofImagePreview.style.padding = '20px';
        proofImagePreview.style.background = '#f8fafc';
      }
    } else {
      fileInputLabel.classList.remove('has-file');
      fileInputLabel.innerHTML = 'üìé Klik untuk upload bukti transfer<br><small style="color:#666;">Format: JPG, PNG, PDF (Max 5MB)</small>';
      proofPreview.style.display = 'none';
    }
  });

  // Event listener untuk enter key pada form login
  document.getElementById('loginPass').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      doLogin();
    }
  });
});

// ==================== SISTEM KONFIRMASI DEPOSIT KE MASTER ====================

// State untuk deposit requests
let state = { 
  members: [], 
  deposits: [],
  depositRequests: [] 
};

// Fungsi untuk mengajukan permintaan deposit
async function submitDepositForApproval() {
  const memberId = document.getElementById('depositMember').value;
  const manualName = document.getElementById('depositManual').value.trim();
  const amount = getCleanAmount();
  let depositDate = document.getElementById('depositDate').value;
  const proofFile = document.getElementById('depositProof').files[0];

  // Validasi input
  if (!amount) {
    alert('Nominal wajib diisi');
    return;
  }

  if (!proofFile) {
    alert('Bukti deposit wajib diupload!');
    return;
  }

  if (!depositDate) {
    depositDate = getCurrentLocalDate();
  }

  let memberName = '';
  let finalMemberId = memberId;

  if (memberId) {
    const member = state.members.find(m => m.id === memberId);
    if (member) {
      memberName = member.name;
    }
  } else if (manualName) {
    memberName = manualName;
    finalMemberId = 'manual_' + uid();
  } else {
    alert('Pilih member atau isi nama manual');
    return;
  }

  // Tampilkan loading
  showNotification('üì§ Mengupload bukti deposit dan mengajukan konfirmasi...');

  try {
    // Upload bukti deposit
    const proofUrl = await uploadDepositProof(proofFile);
    if (!proofUrl) {
      alert('Gagal mengupload bukti deposit');
      return;
    }

    // Ajukan permintaan ke master
    const requestSubmitted = await submitDepositRequest(
      finalMemberId, 
      memberName, 
      amount, 
      depositDate, 
      proofUrl
    );

    if (requestSubmitted) {
      // Reset form
      document.getElementById('depositAmount').value = '';
      document.getElementById('depositManual').value = '';
      document.getElementById('depositMember').value = '';
      document.getElementById('depositDate').value = '';
      document.getElementById('depositProof').value = '';
      document.getElementById('fileInputLabel').classList.remove('has-file');
      document.getElementById('fileInputLabel').innerHTML = 'üìé Klik untuk upload bukti transfer<br><small style="color:#666;">Format: JPG, PNG, PDF (Max 5MB)</small>';
      document.getElementById('proofPreview').style.display = 'none';

      showNotification('‚úÖ Permintaan deposit berhasil diajukan! Menunggu konfirmasi dari CRM Master.');
      
      // Refresh daftar permintaan
      await refreshDepositRequests();
    } else {
      alert('Gagal mengajukan permintaan deposit');
    }

  } catch (error) {
    console.error('Error adding deposit request:', error);
    alert('Error mengajukan permintaan deposit');
  }
}

// Fungsi untuk upload bukti deposit
async function uploadDepositProof(file) {
  if (!currentAdmin) return null;

  try {
    const fileExt = file.name.split('.').pop();
    const fileName = `${currentAdmin.username}_${Date.now()}.${fileExt}`;
    const filePath = `deposit-proofs/${fileName}`;

    const { error: uploadError } = await supabase.storage
      .from('deposit-proofs')
      .upload(filePath, file);

    if (uploadError) throw uploadError;

    const { data: { publicUrl } } = supabase.storage
      .from('deposit-proofs')
      .getPublicUrl(filePath);

    return publicUrl;
  } catch (error) {
    console.error('Error uploading proof:', error);
    return null;
  }
}

// Fungsi untuk submit deposit request
async function submitDepositRequest(memberId, memberName, amount, depositDate, proofImage = null) {
  if (!currentAdmin) {
    alert('Silakan login terlebih dahulu');
    return false;
  }

  try {
    const requestData = {
      id: 'req_' + uid(),
      admin_username: currentAdmin.username,
      member_id: memberId,
      member_name: memberName,
      amount: amount,
      deposit_date: depositDate,
      proof_image_url: proofImage,
      status: 'pending',
      created_at: new Date().toISOString()
    };

    const { error } = await supabase
      .from('deposit_requests')
      .insert([requestData]);

    if (error) throw error;

    return true;
  } catch (error) {
    console.error('Error submitting deposit request:', error);
    return false;
  }
}

// Fungsi untuk memuat daftar permintaan deposit
async function refreshDepositRequests() {
  if (!currentAdmin) return;

  try {
    const { data: requests, error } = await supabase
      .from('deposit_requests')
      .select('*')
      .eq('admin_username', currentAdmin.username)
      .order('created_at', { ascending: false });

    if (error) throw error;

    state.depositRequests = requests || [];
    updateDepositRequestsDisplay();
    updateApprovedDepositsCount();
  } catch (error) {
    console.error('Error loading deposit requests:', error);
  }
}

// Fungsi untuk menampilkan daftar permintaan deposit
function updateDepositRequestsDisplay() {
  const container = document.getElementById('depositRequestsContainer');
  if (!container) return;

  const pendingRequests = state.depositRequests.filter(req => req.status === 'pending');
  const approvedRequests = state.depositRequests.filter(req => req.status === 'approved');
  const rejectedRequests = state.depositRequests.filter(req => req.status === 'rejected');

  if (state.depositRequests.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üìã</div>
        <div class="empty-state-title">Belum Ada Permintaan</div>
        <div class="empty-state-desc">Ajukan deposit baru untuk melihat statusnya di sini</div>
      </div>
    `;
    return;
  }

  container.innerHTML = `
    <div class="request-stats">
      <div class="stat-card pending">
        <div class="stat-value">${pendingRequests.length}</div>
        <div class="stat-label">Menunggu</div>
      </div>
      <div class="stat-card approved">
        <div class="stat-value">${approvedRequests.length}</div>
        <div class="stat-label">Disetujui</div>
      </div>
      <div class="stat-card rejected">
        <div class="stat-value">${rejectedRequests.length}</div>
        <div class="stat-label">Ditolak</div>
      </div>
    </div>

    <div class="requests-section">
      <h4>Permintaan Menunggu Konfirmasi</h4>
      ${pendingRequests.length === 0 ? 
        '<div class="empty-state" style="padding:20px; margin:0;">Tidak ada permintaan menunggu konfirmasi</div>' : 
        pendingRequests.map(request => `
          <div class="request-card pending" id="request-${request.id}">
            <div class="request-header">
              <span class="member-name">${request.member_name}</span>
              <span class="request-date">${formatDateForDisplay(request.deposit_date)}</span>
            </div>
            <div class="request-details">
              <div class="amount">${formatCurrency(request.amount)}</div>
              <div class="proof">
                <a href="${request.proof_image_url}" target="_blank" class="proof-link">Lihat Bukti</a>
              </div>
            </div>
            <div class="request-actions">
              <button onclick="cancelDepositRequest('${request.id}')" class="danger">Batalkan</button>
            </div>
          </div>
        `).join('')
      }
    </div>

    <div class="requests-section">
      <h4>Riwayat Konfirmasi</h4>
      ${approvedRequests.concat(rejectedRequests).length === 0 ? 
        '<div class="empty-state" style="padding:20px; margin:0;">Belum ada riwayat konfirmasi</div>' : 
        approvedRequests.concat(rejectedRequests).map(request => `
          <div class="request-card ${request.status}" id="request-${request.id}">
            <div class="request-header">
              <span class="member-name">${request.member_name}</span>
              <span class="request-date">${formatDateForDisplay(request.deposit_date)}</span>
              <span class="status-badge ${request.status}">
                ${request.status === 'approved' ? '‚úÖ Disetujui' : '‚ùå Ditolak'}
              </span>
            </div>
            <div class="request-details">
              <div class="amount">${formatCurrency(request.amount)}</div>
              <div class="proof">
                <a href="${request.proof_image_url}" target="_blank" class="proof-link">Lihat Bukti</a>
              </div>
              ${request.rejection_reason ? `<div class="notes">Alasan: ${request.rejection_reason}</div>` : ''}
            </div>
            ${request.approved_at ? `
              <div class="request-footer">
                ${request.status === 'approved' ? 'Disetujui' : 'Ditolak'} oleh: ${request.approved_by} pada ${new Date(request.approved_at).toLocaleString('id-ID')}
              </div>
            ` : ''}
          </div>
        `).join('')
      }
    </div>
  `;
}

// Fungsi untuk update count approved deposits
function updateApprovedDepositsCount() {
  const approvedCount = state.depositRequests.filter(req => req.status === 'approved').length;
  document.getElementById('approvedDepositsCount').textContent = `${approvedCount} Disetujui`;
}

// Fungsi untuk membatalkan permintaan deposit
async function cancelDepositRequest(requestId) {
  if (!confirm('Batalkan permintaan deposit ini?')) return;

  try {
    const { error } = await supabase
      .from('deposit_requests')
      .delete()
      .eq('id', requestId)
      .eq('admin_username', currentAdmin.username)
      .eq('status', 'pending');

    if (error) throw error;

    state.depositRequests = state.depositRequests.filter(req => req.id !== requestId);
    updateDepositRequestsDisplay();
    showNotification('Permintaan deposit berhasil dibatalkan');

  } catch (error) {
    console.error('Error canceling deposit request:', error);
    alert('Error membatalkan permintaan deposit');
  }
}

// Fungsi untuk memeriksa status deposit requests secara real-time
function startDepositRequestsPolling() {
  setInterval(() => {
    if (currentAdmin) {
      refreshDepositRequests();
      checkNewApprovals();
    }
  }, 30000); // Check every 30 seconds
}

// Fungsi untuk mengecek approval baru dan auto tambah ke deposit
async function checkNewApprovals() {
  try {
    const { data: newApprovals, error } = await supabase
      .from('deposit_requests')
      .select('*')
      .eq('admin_username', currentAdmin.username)
      .eq('status', 'approved')
      .is('added_to_deposits', null);

    if (error) throw error;

    if (newApprovals && newApprovals.length > 0) {
      for (const approval of newApprovals) {
        // Auto tambah ke deposits
        await addApprovedDeposit(approval);
        
        // Mark as added
        const { error: updateError } = await supabase
          .from('deposit_requests')
          .update({ added_to_deposits: true })
          .eq('id', approval.id);

        if (updateError) throw updateError;
      }
      
      showNotification(`‚úÖ ${newApprovals.length} deposit disetujui otomatis ditambahkan!`);
      refreshDeposits();
      refreshChart();
      refreshDailySummary();
      updateDepositStats();
    }
  } catch (error) {
    console.error('Error checking new approvals:', error);
  }
}

// Fungsi untuk menambahkan deposit yang sudah disetujui
async function addApprovedDeposit(approval) {
  try {
    const depositData = {
      id: 'd' + uid(),
      member_id: approval.member_id,
      member_name: approval.member_name,
      amount: approval.amount,
      date: approval.deposit_date,
      admin_username: currentAdmin.username,
      created_at: new Date().toISOString(),
      approved_by: approval.approved_by,
      approved_at: approval.approved_at
    };

    const { error } = await supabase
      .from('deposits')
      .insert([depositData]);

    if (error) throw error;

    state.deposits.push(depositData);
    
    if (!dateWiseData[approval.deposit_date]) {
      dateWiseData[approval.deposit_date] = {
        members: [],
        deposits: []
      };
    }
    dateWiseData[approval.deposit_date].deposits.push(depositData);

    return true;
  } catch (error) {
    console.error('Error adding approved deposit:', error);
    return false;
  }
}

// Fungsi untuk modal preview bukti
function showProofModal(imageSrc) {
  document.getElementById('modalProofImage').src = imageSrc;
  document.getElementById('proofModal').style.display = 'flex';
}

function closeProofModal() {
  document.getElementById('proofModal').style.display = 'none';
}

// ==================== FUNGSI AUTO SAVE MEMBER KE GOOGLE DRIVE ====================
async function autoSaveMemberToGoogleDrive() {
  if (!currentAdmin) {
    alert('Silakan login terlebih dahulu');
    return;
  }

  const today = getCurrentLocalDate();
  const currentMembers = getFilteredMembers();

  if (currentMembers.length === 0) {
    alert(`‚ùå Tidak ada data member untuk hari ini (${formatDateForDisplay(today)}).\n\nSilakan import data member terlebih dahulu.`);
    return;
  }

  // Tampilkan loading state
  const autoSaveBtn = document.getElementById('autoSaveMemberBtn');
  const autoSaveIcon = document.getElementById('autoSaveMemberIcon');
  const autoSaveText = document.getElementById('autoSaveMemberText');
  
  autoSaveBtn.disabled = true;
  autoSaveIcon.innerHTML = '<div class="spinner"></div>';
  autoSaveText.textContent = 'Menyiapkan file...';

  try {
    // Buat file Excel untuk member
    const fileName = `CRM_Member_${currentAdmin.username}_${today.replace(/-/g, '')}.xlsx`;
    const wb = XLSX.utils.book_new();
    
    // Data member hari ini
    const memberData = currentMembers.map(member => {
      const status = getMemberStatus(member.last_deposit);
      const statusText = status === 'aktif' ? 'Aktif' : status === 'normal' ? 'Normal' : 'Jarang';
      
      return {
        'TANGGAL IMPORT': today,
        'ID MEMBER': extractOriginalId(member.id),
        'NAMA LENGKAP': member.name,
        'NOMOR HP': member.phone,
        'TERAKHIR DEPOSIT': member.last_deposit ? formatDateForDisplay(member.last_deposit) : 'Belum Ada',
        'STATUS': statusText,
        'HP VALID': member.hp_valid ? 'Ya' : 'Tidak',
        'SUDAH DEPOSIT': member.deposit_valid ? 'Ya' : 'Tidak',
        'ADA RESPON': member.has_response ? 'Ya' : 'Tidak',
        'TANGGAL BUAT': member.created_at ? member.created_at.split('T')[0] : today
      };
    });
    
    const wsMembers = XLSX.utils.json_to_sheet(memberData);
    XLSX.utils.book_append_sheet(wb, wsMembers, "Data Member");

    // Summary sheet
    const totalMembers = currentMembers.length;
    const aktifMembers = currentMembers.filter(m => getMemberStatus(m.last_deposit) === 'aktif').length;
    const normalMembers = currentMembers.filter(m => getMemberStatus(m.last_deposit) === 'normal').length;
    const jarangMembers = currentMembers.filter(m => getMemberStatus(m.last_deposit) === 'jarang').length;
    const hpValidCount = currentMembers.filter(m => m.hp_valid).length;
    const depositValidCount = currentMembers.filter(m => m.deposit_valid).length;
    const hasResponseCount = currentMembers.filter(m => m.has_response).length;

    const summaryData = [
      ['LAPORAN DATA MEMBER HARIAN - AUTO SAVE'],
      [''],
      ['Admin:', currentAdmin.username],
      ['Nama Admin:', currentAdmin.name || '-'],
      ['Tanggal Export:', new Date().toLocaleString('id-ID')],
      ['Tanggal Data:', formatDateForDisplay(today)],
      [''],
      ['STATISTIK MEMBER:'],
      ['Total Member:', totalMembers],
      ['Member Aktif (‚â§7 hari):', aktifMembers],
      ['Member Normal (‚â§30 hari):', normalMembers],
      ['Member Jarang (>30 hari):', jarangMembers],
      ['HP Valid:', hpValidCount],
      ['Sudah Deposit:', depositValidCount],
      ['Ada Respon:', hasResponseCount],
      [''],
      ['PERSENTASE:'],
      ['Aktif:', `${totalMembers > 0 ? Math.round((aktifMembers / totalMembers) * 100) : 0}%`],
      ['Normal:', `${totalMembers > 0 ? Math.round((normalMembers / totalMembers) * 100) : 0}%`],
      ['Jarang:', `${totalMembers > 0 ? Math.round((jarangMembers / totalMembers) * 100) : 0}%`],
      ['HP Valid:', `${totalMembers > 0 ? Math.round((hpValidCount / totalMembers) * 100) : 0}%`],
      [''],
      ['FORMAT DATA:'],
      ['‚Ä¢ TANGGAL IMPORT - Tanggal data diimport/diterima'],
      ['‚Ä¢ ID MEMBER - ID unik member dari database'],
      ['‚Ä¢ NAMA LENGKAP - Nama lengkap member'],
      ['‚Ä¢ NOMOR HP - Nomor telepon member'],
      ['‚Ä¢ TERAKHIR DEPOSIT - Tanggal deposit terakhir'],
      ['‚Ä¢ STATUS - Status aktivitas member'],
      ['‚Ä¢ HP VALID - Status validasi nomor HP'],
      ['‚Ä¢ SUDAH DEPOSIT - Status sudah melakukan deposit'],
      ['‚Ä¢ ADA RESPON - Status respons dari member'],
      [''],
      ['FILE INI SIAP DIUPLOAD KE GOOGLE DRIVE'],
      ['Terakhir update:', new Date().toLocaleString('id-ID')],
      [''],
      ['INSTRUKSI UPLOAD:'],
      ['1. Buka drive.google.com'],
      ['2. Klik "New" ‚Üí "File upload"'],
      ['3. Pilih file ini'],
      ['4. Tunggu hingga upload selesai'],
      ['5. Data member sudah aman di cloud!']
    ];
    
    const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
    XLSX.utils.book_append_sheet(wb, wsSummary, "Summary Member");
    
    // Download file
    XLSX.writeFile(wb, fileName);
    
    // Simpan info ke localStorage bahwa hari ini sudah auto save member
    localStorage.setItem(`autoSaveMember_${currentAdmin.username}_${today}`, 'completed');
    localStorage.setItem(`lastMemberSave_${currentAdmin.username}`, new Date().toISOString());
    
    // Update UI
    autoSaveIcon.textContent = '‚úÖ';
    autoSaveText.textContent = 'File Siap!';
    
    // Update status display
    updateMemberAutoSaveStatus();
    
    showNotification(`‚úÖ File member "${fileName}" berhasil dibuat!\n\nTotal: ${totalMembers} member\nAktif: ${aktifMembers}, Normal: ${normalMembers}, Jarang: ${jarangMembers}`);
    
    // Auto buka Google Drive setelah 2 detik
    setTimeout(() => {
      const openDrive = confirm(`üìÅ File member "${fileName}" berhasil didownload!\n\nTotal data: ${totalMembers} member\n\nBuka Google Drive untuk upload file sekarang?\n\nKlik "OK" untuk membuka drive.google.com`);
      
      if (openDrive) {
        window.open('https://drive.google.com/drive/u/0/my-drive', '_blank');
        
        // Tampilkan instruksi detail
        setTimeout(() => {
          showNotification(`
            üìã **Instruksi Upload ke Google Drive:**
            
            1. Di Google Drive, klik **"New"** ‚Üí **"File upload"**
            2. Pilih file **${fileName}** dari folder Downloads
            3. Tunggu hingga progress bar selesai
            4. File member sudah aman di cloud! üéâ
            
            üí° **Tips:** Drag & drop file langsung ke Google Drive lebih cepat!
          `);
        }, 1000);
      }
    }, 2000);
    
  } catch (error) {
    console.error('Auto save member error:', error);
    
    // Error state
    autoSaveIcon.textContent = '‚ùå';
    autoSaveText.textContent = 'Gagal!';
    
    showNotification('‚ùå Gagal membuat file member Excel: ' + error.message);
  }

  // Reset button state setelah 5 detik
  setTimeout(() => {
    autoSaveBtn.disabled = false;
    autoSaveIcon.textContent = 'üìÅ';
    autoSaveText.textContent = 'Auto Save Member ke Drive';
  }, 5000);
}

// ==================== FUNGSI UPDATE STATUS AUTO SAVE MEMBER ====================
function updateMemberAutoSaveStatus() {
  if (!currentAdmin) return;

  const today = getCurrentLocalDate();
  const currentMembers = getFilteredMembers();
  const statusElement = document.getElementById('memberAutoSaveStatus');
  const statusText = document.getElementById('memberSaveStatusText');
  const lastSaveTime = document.getElementById('lastSaveTime');
  const saveStats = document.getElementById('memberSaveStats');

  if (currentMembers.length === 0) {
    statusElement.style.display = 'none';
    return;
  }

  statusElement.style.display = 'block';

  // Cek status save hari ini
  const alreadySaved = localStorage.getItem(`autoSaveMember_${currentAdmin.username}_${today}`) === 'completed';
  const lastSave = localStorage.getItem(`lastMemberSave_${currentAdmin.username}`);

  if (alreadySaved) {
    statusText.textContent = 'Sudah Disimpan Hari Ini';
    statusText.className = 'status-indicator status-success';
  } else {
    statusText.textContent = 'Belum Disimpan Hari Ini';
    statusText.className = 'status-indicator status-warning';
  }

  // Tampilkan waktu terakhir save
  if (lastSave) {
    const lastSaveDate = new Date(lastSave);
    lastSaveTime.textContent = `Terakhir: ${lastSaveDate.toLocaleString('id-ID')}`;
  } else {
    lastSaveTime.textContent = 'Belum pernah disimpan';
  }

  // Tampilkan statistik
  const totalMembers = currentMembers.length;
  const aktifMembers = currentMembers.filter(m => getMemberStatus(m.last_deposit) === 'aktif').length;
  const normalMembers = currentMembers.filter(m => getMemberStatus(m.last_deposit) === 'normal').length;
  const jarangMembers = currentMembers.filter(m => getMemberStatus(m.last_deposit) === 'jarang').length;

  saveStats.innerHTML = `
    <strong>Statistik:</strong> Total ${totalMembers} member 
    (Aktif: ${aktifMembers}, Normal: ${normalMembers}, Jarang: ${jarangMembers})
  `;
}

// ==================== FUNGSI UNTUK KELIPATAN DEPOSIT ====================
function calculateDepositMultiples(deposits) {
  const grouped = {};
  
  deposits.forEach(deposit => {
    const key = `${deposit.date}_${deposit.member_id}_${deposit.amount}`;
    
    if (!grouped[key]) {
      grouped[key] = {
        date: deposit.date,
        member_id: deposit.member_id,
        member_name: deposit.member_name,
        amount: deposit.amount,
        count: 0,
        type: deposit.member_id.startsWith('manual_') ? 'Manual' : 'Database',
        original_deposits: []
      };
    }
    
    grouped[key].count++;
    grouped[key].original_deposits.push(deposit);
  });
  
  return Object.values(grouped);
}

// ==================== FUNGSI AUTO SAVE KE GOOGLE DRIVE ====================
async function autoSaveToGoogleDrive() {
  if (!currentAdmin) {
    alert('Silakan login terlebih dahulu');
    return;
  }

  const today = getCurrentLocalDate();
  const todayDeposits = state.deposits.filter(d => d.date === today);

  if (todayDeposits.length === 0) {
    alert(`‚ùå Tidak ada data deposit untuk hari ini (${formatDateForDisplay(today)}).\n\nSilakan tambah data deposit terlebih dahulu.`);
    return;
  }

  // Tampilkan loading state
  const autoSaveBtn = document.getElementById('autoSaveBtn');
  const autoSaveIcon = document.getElementById('autoSaveIcon');
  const autoSaveText = document.getElementById('autoSaveText');
  
  autoSaveBtn.disabled = true;
  autoSaveIcon.innerHTML = '<div class="spinner"></div>';
  autoSaveText.textContent = 'Menyiapkan file...';

  try {
    // Hitung kelipatan deposit
    const depositMultiples = calculateDepositMultiples(todayDeposits);
    
    // Buat file Excel
    const fileName = `CRM_Deposit_${currentAdmin.username}_${today.replace(/-/g, '')}.xlsx`;
    const wb = XLSX.utils.book_new();
    
    // Data deposit hari ini - FORMAT BARU dengan kelipatan
    const depositData = depositMultiples.map(item => {
      const memberId = item.member_id.startsWith('manual_') ? 'MANUAL' : extractOriginalId(item.member_id);
      
      return {
        'TANGGAL': item.date,
        'ID MEMBER': memberId,
        'Jumlah Deposit': item.amount,
        'Kelipatan Deposit': item.count,
        'Tipe Data': item.type
      };
    });
    
    const wsDeposits = XLSX.utils.json_to_sheet(depositData);
    XLSX.utils.book_append_sheet(wb, wsDeposits, "Deposit Hari Ini");
    
    // Summary sheet
    const totalDeposit = todayDeposits.reduce((sum, d) => sum + d.amount, 0);
    const uniqueMembers = new Set(todayDeposits.map(d => d.member_id)).size;
    const manualDeposits = todayDeposits.filter(d => d.member_id.startsWith('manual_')).length;
    const memberDeposits = todayDeposits.length - manualDeposits;
    
    // Hitung statistik kelipatan
    const multipleStats = {};
    depositMultiples.forEach(item => {
      if (!multipleStats[item.count]) {
        multipleStats[item.count] = 0;
      }
      multipleStats[item.count]++;
    });
    
    const multipleStatsText = Object.entries(multipleStats)
      .map(([count, freq]) => `‚Ä¢ ${count}x deposit: ${freq} transaksi`)
      .join('\n');
    
    const summaryData = [
      ['LAPORAN DEPOSIT HARIAN - AUTO SAVE'],
      [''],
      ['Admin:', currentAdmin.username],
      ['Nama Admin:', currentAdmin.name || '-'],
      ['Tanggal:', formatDateForDisplay(today)],
      ['Waktu Export:', new Date().toLocaleString('id-ID')],
      [''],
      ['STATISTIK HARIAN:'],
      ['Total Transaksi:', todayDeposits.length],
      ['Transaksi Database:', memberDeposits],
      ['Transaksi Manual:', manualDeposits],
      ['Member Unik:', uniqueMembers],
      ['Total Pendapatan:', `Rp ${totalDeposit.toLocaleString('id-ID')}`],
      ['Rata-rata per Transaksi:', `Rp ${todayDeposits.length > 0 ? Math.round(totalDeposit / todayDeposits.length).toLocaleString('id-ID') : '0'}`],
      [''],
      ['STATISTIK KELIPATAN:'],
      ...(multipleStatsText ? multipleStatsText.split('\n').map(line => [line]) : [['Tidak ada kelipatan']]),
      [''],
      ['FORMAT DATA:'],
      ['‚Ä¢ TANGGAL - Tanggal transaksi deposit'],
      ['‚Ä¢ ID MEMBER - ID member dari database atau "MANUAL"'],
      ['‚Ä¢ Jumlah Deposit - Nominal deposit dalam angka'],
      ['‚Ä¢ Kelipatan Deposit - Jumlah transaksi dengan nominal sama'],
      ['‚Ä¢ Tipe Data - "Database" untuk member terdaftar, "Manual" untuk input manual'],
      [''],
      ['CONTOH:'],
      ['‚Ä¢ Member "dena" deposit 50.000 sebanyak 3x ‚Üí Kelipatan: 3'],
      ['‚Ä¢ Member "kenji11" deposit 50.000 sebanyak 1x ‚Üí Kelipatan: 1'],
      ['‚Ä¢ Member "dena" deposit 150.000 sebanyak 1x ‚Üí Kelipatan: 1'],
      [''],
      ['FILE INI SIAP DIUPLOAD KE GOOGLE DRIVE'],
      ['Terakhir update:', new Date().toLocaleString('id-ID')],
      [''],
      ['INSTRUKSI UPLOAD:'],
      ['1. Buka drive.google.com'],
      ['2. Klik "New" ‚Üí "File upload"'],
      ['3. Pilih file ini'],
      ['4. Tunggu hingga upload selesai'],
      ['5. Data sudah aman di cloud!']
    ];
    
    const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
    XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");
    
    // Download file
    XLSX.writeFile(wb, fileName);
    
    // Simpan info ke localStorage bahwa hari ini sudah auto save
    localStorage.setItem(`autoSave_${currentAdmin.username}_${today}`, 'completed');
    
    // Update UI
    autoSaveIcon.textContent = '‚úÖ';
    autoSaveText.textContent = 'File Siap!';
    
    showNotification(`‚úÖ File "${fileName}" berhasil dibuat!\n\nFormat: TANGGAL | ID MEMBER | Jumlah Deposit | Kelipatan Deposit | Tipe Data`);
    
    // Auto buka Google Drive setelah 2 detik
    setTimeout(() => {
      const openDrive = confirm(`üìÅ File "${fileName}" berhasil didownload!\n\nFormat data:\n‚Ä¢ TANGGAL\n‚Ä¢ ID MEMBER  \n‚Ä¢ Jumlah Deposit\n‚Ä¢ Kelipatan Deposit\n‚Ä¢ Tipe Data (Database/Manual)\n\nBuka Google Drive untuk upload file sekarang?\n\nKlik "OK" untuk membuka drive.google.com`);
      
      if (openDrive) {
        window.open('https://drive.google.com/drive/u/0/my-drive', '_blank');
        
        // Tampilkan instruksi detail
        setTimeout(() => {
          showNotification(`
            üìã **Instruksi Upload ke Google Drive:**
            
            1. Di Google Drive, klik **"New"** ‚Üí **"File upload"**
            2. Pilih file **${fileName}** dari folder Downloads
            3. Tunggu hingga progress bar selesai
            4. File sudah aman di cloud! üéâ
            
            üí° **Tips:** Drag & drop file langsung ke Google Drive lebih cepat!
          `);
        }, 1000);
      }
    }, 2000);
    
  } catch (error) {
    console.error('Auto save error:', error);
    
    // Error state
    autoSaveIcon.textContent = '‚ùå';
    autoSaveText.textContent = 'Gagal!';
    
    showNotification('‚ùå Gagal membuat file Excel: ' + error.message);
  }

  // Reset button state setelah 5 detik
  setTimeout(() => {
    autoSaveBtn.disabled = false;
    autoSaveIcon.textContent = '‚òÅÔ∏è';
    autoSaveText.textContent = 'Auto Save ke Drive';
  }, 5000);
}

// ==================== FUNGSI UNTUK UPDATE STATISTIK DEPOSIT ====================
function updateDepositStats() {
  const today = getCurrentLocalDate();
  const todayDeposits = state.deposits.filter(d => d.date === today);
  
  const totalDeposit = todayDeposits.reduce((sum, d) => sum + d.amount, 0);
  const depositCount = todayDeposits.length;
  
  // Update stats display
  document.getElementById('todayDepositCount').textContent = depositCount;
  document.getElementById('todayDepositTotal').textContent = `Rp ${totalDeposit.toLocaleString('id-ID')}`;
  
  // Update tombol auto save
  const autoSaveBtn = document.getElementById('autoSaveBtn');
  const autoSaveText = document.getElementById('autoSaveText');
  const autoSaveIcon = document.getElementById('autoSaveIcon');
  
  if (depositCount === 0) {
    autoSaveBtn.disabled = true;
    autoSaveBtn.style.opacity = '0.6';
    autoSaveText.textContent = 'Tidak Ada Data';
    autoSaveIcon.textContent = 'üì≠';
  } else {
    autoSaveBtn.disabled = false;
    autoSaveBtn.style.opacity = '1';
    
    // Cek apakah hari ini sudah disimpan
    const alreadySaved = localStorage.getItem(`autoSave_${currentAdmin.username}_${today}`) === 'completed';
    if (alreadySaved) {
      autoSaveText.textContent = 'Sudah Disimpan';
      autoSaveIcon.textContent = '‚úÖ';
    } else {
      autoSaveText.textContent = 'Auto Save ke Drive';
      autoSaveIcon.textContent = '‚òÅÔ∏è';
    }
  }
}

// ==================== MODAL FUNCTIONS ====================
function showResetMemberModal() {
  document.getElementById('resetMemberModal').style.display = 'flex';
  document.getElementById('resetDateInput').value = '';
  document.getElementById('resetPreview').style.display = 'none';
  document.getElementById('confirmResetBtn').style.display = 'none';
  document.getElementById('resetPreviewContent').innerHTML = '';
}

function closeResetModal() {
  document.getElementById('resetMemberModal').style.display = 'none';
}

function previewResetData() {
  const resetDate = document.getElementById('resetDateInput').value;
  
  if (!resetDate) {
    alert('Silakan pilih tanggal terlebih dahulu');
    return;
  }

  // Validasi format tanggal
  const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
  if (!dateRegex.test(resetDate)) {
    alert('Format tanggal tidak valid. Gunakan format YYYY-MM-DD');
    return;
  }

  // Validasi tanggal tidak di masa depan
  const today = getCurrentLocalDate();
  if (resetDate > today) {
    alert('Tidak bisa reset data untuk tanggal masa depan');
    return;
  }

  currentResetDate = resetDate;
  showNotification('üîç Mencari data member...');

  // Cari member yang dibuat pada tanggal tersebut
  previewMembers = state.members.filter(member => {
    const memberDate = member.created_at ? member.created_at.split('T')[0] : '';
    return memberDate === resetDate;
  });

  const previewContent = document.getElementById('resetPreviewContent');
  const previewSection = document.getElementById('resetPreview');
  const confirmBtn = document.getElementById('confirmResetBtn');

  if (previewMembers.length === 0) {
    previewContent.innerHTML = `
      <div style="text-align:center; padding:20px; color:#666;">
        <div style="font-size:24px; margin-bottom:8px;">üì≠</div>
        <div style="font-weight:600; margin-bottom:4px;">Tidak Ada Data</div>
        <div>Tidak ditemukan data member untuk tanggal ${formatDateForDisplay(resetDate)}</div>
      </div>
    `;
    confirmBtn.style.display = 'none';
  } else {
    previewContent.innerHTML = `
      <div style="margin-bottom:12px;">
        <strong>Tanggal:</strong> ${formatDateForDisplay(resetDate)}<br>
        <strong>Jumlah Member:</strong> ${previewMembers.length} data<br>
        <strong>Contoh Data:</strong>
      </div>
      <div style="max-height:120px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:6px; padding:8px; background:white;">
        ${previewMembers.slice(0, 10).map(member => `
          <div style="padding:4px 0; border-bottom:1px solid #f3f4f6;">
            <span style="font-family:monospace; font-size:12px;">${extractOriginalId(member.id)}</span> - ${member.name}
          </div>
        `).join('')}
        ${previewMembers.length > 10 ? `<div style="padding:4px 0; color:#666; font-style:italic;">... dan ${previewMembers.length - 10} data lainnya</div>` : ''}
      </div>
      <div style="margin-top:8px; padding:8px; background:#fef2f2; border-radius:4px; border-left:4px solid #dc2626;">
        <small style="color:#dc2626;">
          ‚ö†Ô∏è Data yang dihapus tidak dapat dikembalikan. Pastikan Anda sudah backup data jika diperlukan.
        </small>
      </div>
    `;
    confirmBtn.style.display = 'block';
  }

  previewSection.style.display = 'block';
}

// ==================== FUNGSI RESET DATA ====================
async function confirmResetMember() {
  if (!currentResetDate || previewMembers.length === 0) {
    alert('Tidak ada data yang akan direset');
    return;
  }

  const finalConfirm = confirm(
    `‚ö†Ô∏è KONFIRMASI HAPUS DATA MEMBER\n\n` +
    `Tanggal: ${formatDateForDisplay(currentResetDate)}\n` +
    `Jumlah Data: ${previewMembers.length} member\n\n` +
    `Data deposit TIDAK AKAN DIHAPUS dan tetap aman!\n` +
    `Tindakan ini tidak dapat dibatalkan!\n\n` +
    `Lanjutkan menghapus?`
  );

  if (!finalConfirm) return;

  try {
    showNotification('üîÑ Memproses reset data member...');

    // Hapus member dari database
    const { error: deleteError } = await supabase
      .from('members')
      .delete()
      .eq('admin_username', currentAdmin.username)
      .gte('created_at', currentResetDate + 'T00:00:00.000Z')
      .lte('created_at', currentResetDate + 'T23:59:59.999Z');

    if (deleteError) throw deleteError;

    // Update state lokal
    state.members = state.members.filter(member => {
      const memberDate = member.created_at ? member.created_at.split('T')[0] : '';
      return memberDate !== currentResetDate;
    });

    // Refresh UI
    refreshMembers();
    updateMemberAutoSaveStatus();
    closeResetModal();

    showNotification(`‚úÖ Reset berhasil! ${previewMembers.length} member pada ${formatDateForDisplay(currentResetDate)} telah dihapus`);

    // Tawarkan untuk import data baru dari master
    setTimeout(() => {
      if (confirm(`‚úÖ Reset selesai!\n\n${previewMembers.length} data member pada ${formatDateForDisplay(currentResetDate)} telah dihapus.\n\nSekarang Anda bisa menerima data baru dari Master Admin.\n\nLanjutkan import data dari Master?`)) {
        importFromMaster();
      }
    }, 1000);

  } catch (error) {
    console.error('Error resetting member data by date:', error);
    alert('‚ùå Error reset data member: ' + error.message);
    showNotification('‚ùå Gagal reset data member');
  }
}

async function resetAdminData() {
  if (!confirm(`üí• HAPUS SEMUA DATA ADMIN?\n\nTindakan ini akan menghapus SEMUA DATA (semua member + semua deposit) admin ${currentAdmin.username}.\nTindakan ini tidak dapat dibatalkan!`)) return;

  try {
    showNotification('üîÑ Menghapus semua data...');

    const { error: depositError } = await supabase
      .from('deposits')
      .delete()
      .eq('admin_username', currentAdmin.username);

    if (depositError) throw depositError;

    const { error: memberError } = await supabase
      .from('members')
      .delete()
      .eq('admin_username', currentAdmin.username);

    if (memberError) throw memberError;

    // Reset state
    state.members = [];
    state.deposits = [];
    state.depositRequests = [];
    dateWiseData = {};
    
    // Refresh UI
    refreshMembers();
    refreshDeposits();
    refreshChart();
    refreshDailySummary();
    updateDepositStats();
    updateMemberAutoSaveStatus();
    updateDepositRequestsDisplay();

    showNotification('üí• Semua data admin berhasil direset!');
    alert('‚úÖ Semua data admin berhasil direset! Sistem sekarang bersih.');

  } catch (error) {
    console.error('Error resetting data:', error);
    alert('‚ùå Error reset data: ' + error.message);
    showNotification('‚ùå Gagal reset data');
  }
}

// ==================== IMPOR DARI MASTER ====================
async function importFromMaster() {
  const currentDate = getCurrentLocalDate();
  
  const confirmImport = confirm(
    `üì• IMPORT DATA DARI MASTER ADMIN\n\n` +
    `Tanggal: ${formatDateForDisplay(currentDate)}\n\n` +
    `Fitur ini akan tersedia setelah integrasi dengan Master Admin selesai.\n\n` +
    `Untuk sekarang, silakan tambah data member manual melalui form "Tambah Deposit".`
  );
  
  if (!confirmImport) return;

  try {
    showNotification('üîÑ Memproses import data dari Master...');

    // Tampilkan pesan bahwa fitur belum tersedia
    alert('üöß Fitur Import dari Master Admin sedang dalam pengembangan.\n\nUntuk sementara, silakan gunakan:\n‚Ä¢ Form "Tambah Deposit" untuk data manual\n‚Ä¢ Atau hubungi developer untuk integrasi Master Admin');

    return; // Hentikan proses

  } catch (error) {
    console.error('Error importing from master:', error);
    alert('‚ùå Error import data master: ' + error.message);
    showNotification('‚ùå Gagal import data master');
  }
}

// ==================== KODE YANG SUDAH ADA ====================
let chartInstance = null;
let currentView = 'daily';
let dateWiseData = {};

function getCurrentDataSet() {
  const currentDate = getCurrentLocalDate();
  
  if (!dateWiseData[currentDate]) {
    dateWiseData[currentDate] = {
      members: [],
      deposits: []
    };
  }
  
  return dateWiseData[currentDate];
}

function getFilteredMembers() {
  const currentDataSet = getCurrentDataSet();
  return currentDataSet.members || [];
}

function getFilteredDeposits() {
  const currentDataSet = getCurrentDataSet();
  return currentDataSet.deposits || [];
}

function initializeDailySystem() {
  const today = getCurrentLocalDate();
  const lastViewDate = localStorage.getItem('lastViewDate');
  
  if (lastViewDate !== today) {
    localStorage.setItem('lastViewDate', today);
    localStorage.setItem('currentViewDate', today);
    showNotification('üîÑ Sistem direset untuk tanggal ' + formatDateForDisplay(today));
  } else {
    const savedDate = localStorage.getItem('currentViewDate') || today;
    setCurrentViewDate(savedDate);
  }
}

function resetToToday() {
  const today = getCurrentLocalDate();
  setCurrentViewDate(today);
  
  document.getElementById('fromDate').value = '';
  document.getElementById('toDate').value = '';
  document.getElementById('depositDate').value = '';
  
  refreshMembers();
  refreshDeposits();
  refreshChart();
  refreshDailySummary();
  updateDepositStats();
  updateMemberAutoSaveStatus();
  
  showNotification('üìÖ Kembali ke data hari ini: ' + formatDateForDisplay(today));
}

function setCurrentViewDate(date) {
  localStorage.setItem('currentViewDate', date);
  updateDateDisplay(date);
}

function updateDateDisplay(date) {
  const today = getCurrentLocalDate();
  const isToday = date === today;
  
  const dateDisplayElement = document.getElementById('currentDateDisplay');
  const displayText = formatDateForDisplay(date) + (isToday ? ' (HARI INI)' : '');
  dateDisplayElement.textContent = displayText;
  
  const infoElement = document.getElementById('dateRangeInfo');
  if (isToday) {
    infoElement.innerHTML = `üìÖ <strong>HARI INI</strong> - ${formatDateForDisplay(date)} - Mulai data fresh`;
    infoElement.style.background = '#f0f9ff';
    infoElement.style.borderColor = '#bae6fd';
    infoElement.style.color = '#0369a1';
  } else {
    infoElement.innerHTML = `üìÖ <strong>MODE VIEW TANGGAL:</strong> ${formatDateForDisplay(date)}`;
    infoElement.style.background = '#fef3c7';
    infoElement.style.borderColor = '#fcd34d';
    infoElement.style.color = '#92400e';
  }
}

function getCurrentViewDate() {
  return localStorage.getItem('currentViewDate') || getCurrentLocalDate();
}

function goToPreviousDay() {
  const currentDate = new Date(getCurrentViewDate());
  currentDate.setDate(currentDate.getDate() - 1);
  const prevDate = currentDate.toISOString().split('T')[0];
  navigateToDate(prevDate);
}

function goToNextDay() {
  const currentDate = new Date(getCurrentViewDate());
  currentDate.setDate(currentDate.getDate() + 1);
  const nextDate = currentDate.toISOString().split('T')[0];
  
  const today = getCurrentLocalDate();
  if (nextDate > today) {
    showNotification('Tidak bisa navigasi ke tanggal masa depan');
    return;
  }
  
  navigateToDate(nextDate);
}

function goToToday() {
  resetToToday();
}

function navigateToDate(targetDate) {
  setCurrentViewDate(targetDate);
  refreshMembers();
  refreshDeposits();
  refreshChart();
  refreshDailySummary();
  updateDepositStats();
  updateMemberAutoSaveStatus();
  showNotification('üìÖ Melihat data tanggal: ' + formatDateForDisplay(targetDate));
}

function showNotification(message) {
  // Hapus notifikasi sebelumnya
  const existingNotifications = document.querySelectorAll('.custom-notification');
  existingNotifications.forEach(notif => notif.remove());

  const notification = document.createElement('div');
  notification.className = 'custom-notification';
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #10b981;
    color: white;
    padding: 16px 20px;
    border-radius: 12px;
    z-index: 10000;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    font-size: 14px;
    max-width: 400px;
    line-height: 1.5;
    border-left: 4px solid #059669;
    white-space: pre-line;
  `;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentNode) {
      notification.style.opacity = '0';
      notification.style.transform = 'translateX(100px)';
      setTimeout(() => {
        if (notification.parentNode) {
          document.body.removeChild(notification);
        }
      }, 300);
    }
  }, 5000);
}

function formatDateForDisplay(dateString) {
  if (!dateString) return '-';
  
  const date = new Date(dateString);
  return date.toLocaleDateString('id-ID', {
    day: 'numeric',
    month: 'long',
    year: 'numeric',
    timeZone: 'Asia/Jakarta'
  });
}

function getCurrentLocalDate() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function downloadForGoogleDrive() {
  if (!currentAdmin) {
    alert('Silakan login terlebih dahulu');
    return;
  }

  try {
    showSheetMessage('üìä Membuat file Excel...', true);
    
    const today = new Date();
    const dateStr = today.toLocaleDateString('id-ID').replace(/\//g, '-');
    const fileName = `CRM_Data_${currentAdmin.username}_${dateStr}.xlsx`;
    
    const wb = XLSX.utils.book_new();
    
    const memberData = state.members.map(m => ({
      'ID Member': extractOriginalId(m.id),
      'Nama Lengkap': m.name,
      'Nomor HP': m.phone,
      'Terakhir Deposit': m.last_deposit,
      'Status': getMemberStatus(m.last_deposit),
      'HP Valid': m.hp_valid ? 'Ya' : 'Tidak',
      'Deposit Valid': m.deposit_valid ? 'Ya' : 'Tidak',
      'Ada Respon': m.has_response ? 'Ya' : 'Tidak',
      'Keterangan': getMemberNotes(m)
    }));
    
    const wsMembers = XLSX.utils.json_to_sheet(memberData);
    XLSX.utils.book_append_sheet(wb, wsMembers, "Data Member");
    
    // Data deposit dengan kelipatan untuk download manual
    const depositMultiples = calculateDepositMultiples(state.deposits);
    const depositData = depositMultiples.map(item => {
      const memberId = item.member_id.startsWith('manual_') ? 'MANUAL' : extractOriginalId(item.member_id);
      
      return {
        'TANGGAL': item.date,
        'ID MEMBER': memberId,
        'Jumlah Deposit': item.amount,
        'Kelipatan Deposit': item.count,
        'Tipe Data': item.type
      };
    });
    
    const wsDeposits = XLSX.utils.json_to_sheet(depositData);
    XLSX.utils.book_append_sheet(wb, wsDeposits, "Riwayat Deposit");
    
    const totalPendapatan = state.deposits.reduce((sum, d) => sum + d.amount, 0);
    
    let periodInfo = 'Semua Data Historis';
    const from = document.getElementById('fromDate').value;
    const to = document.getElementById('toDate').value;
    if (from || to) {
      periodInfo = `Periode: ${from || 'Awal'} - ${to || 'Sekarang'}`;
    }

    const summaryData = [
      ['LAPORAN CRM ADMIN'],
      [''],
      ['Admin:', currentAdmin.username],
      ['Nama Admin:', currentAdmin.name || '-'],
      ['Tanggal Export:', new Date().toLocaleString('id-ID')],
      ['Rentang Data:', periodInfo],
      [''],
      ['STATISTIK DATA:'],
      ['Total Member:', state.members.length],
      ['Total Transaksi Deposit:', state.deposits.length],
      ['Total Pendapatan:', `Rp ${totalPendapatan.toLocaleString('id-ID')}`],
      ['Rata-rata per Transaksi:', `Rp ${state.deposits.length > 0 ? Math.round(totalPendapatan / state.deposits.length).toLocaleString('id-ID') : '0'}`],
      [''],
      ['STATUS MEMBER:'],
      ['Member Aktif (‚â§7 hari):', state.members.filter(m => getMemberStatus(m.last_deposit) === 'aktif').length],
      ['Member Normal (‚â§30 hari):', state.members.filter(m => getMemberStatus(m.last_deposit) === 'normal').length],
      ['Member Jarang (>30 hari):', state.members.filter(m => getMemberStatus(m.last_deposit) === 'jarang').length],
      [''],
      ['INSTRUKSI:'],
      ['1. Simpan file ini di komputer Anda'],
      ['2. Buka drive.google.com'],
      ['3. Upload file ini ke Google Drive'],
      ['4. File Anda sudah aman di cloud!'],
      [''],
      ['File ini auto-generate dari CRM ADMIN'],
      ['Terakhir update:', new Date().toLocaleString('id-ID')]
    ];
    
    const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
    XLSX.utils.book_append_sheet(wb, wsSummary, "Summary Laporan");
    
    XLSX.writeFile(wb, fileName);
    
    showSheetMessage('‚úÖ File Excel berhasil didownload!', true);
    
    setTimeout(() => {
      if (confirm(`File "${fileName}" berhasil didownload!\n\nSekarang buka Google Drive untuk upload file?\n\nKlik OK untuk membuka drive.google.com`)) {
        window.open('https://drive.google.com', '_blank');
      }
    }, 1000);
    
  } catch (error) {
    console.error('Download error:', error);
    showSheetMessage('‚ùå Gagal membuat file Excel', false);
  }
}

function getMemberNotes(member) {
  const notes = [];
  if (member.hp_valid) notes.push('HP Valid');
  if (member.deposit_valid) notes.push('Deposit Valid');
  if (member.has_response) notes.push('Ada Respon');
  return notes.join(', ') || '-';
}

function showSheetMessage(message, isSuccess) {
  const messageElement = document.getElementById('sheetMessage');
  
  messageElement.textContent = message;
  messageElement.style.display = 'block';
  messageElement.style.background = isSuccess ? '#f0fdf4' : '#fef2f2';
  messageElement.style.border = isSuccess ? '1px solid #bbf7d0' : '1px solid #fecaca';
  messageElement.style.color = isSuccess ? '#166534' : '#dc2626';
  
  setTimeout(() => {
    messageElement.style.display = 'none';
  }, 5000);
}

function uid() { 
  return 'id' + Math.random().toString(36).slice(2, 9); 
}

function extractOriginalId(fullId) {
  if (!fullId) return '';
  if (fullId.includes('_') && fullId.startsWith('batch_')) {
    const parts = fullId.split('_');
    const originalId = parts.slice(3).join('_');
    return originalId || fullId;
  }
  return fullId;
}

function formatCurrency(amount) {
  return new Intl.NumberFormat('id-ID', {
    style: 'currency',
    currency: 'IDR',
    minimumFractionDigits: 0
  }).format(amount);
}

function formatDate(dateString) {
  if (!dateString) return '-';
  const date = new Date(dateString);
  return date.toLocaleDateString('id-ID', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
}

function getMemberStatus(lastDeposit) {
  if (!lastDeposit) return 'jarang';
  const last = new Date(lastDeposit);
  const now = new Date();
  const diff = (now - last) / (1000 * 60 * 60 * 24);
  if (diff <= 7) return 'aktif';
  if (diff <= 30) return 'normal';
  return 'jarang';
}

async function loadAdminData() {
  if (!currentAdmin) return;

  try {
    const { data: allMembers, error: membersError } = await supabase
      .from('members')
      .select('*')
      .eq('admin_username', currentAdmin.username)
      .order('last_deposit', { ascending: false });

    if (membersError) throw membersError;

    const { data: allDeposits, error: depositsError } = await supabase
      .from('deposits')
      .select('*')
      .eq('admin_username', currentAdmin.username)
      .order('date', { ascending: false });

    if (depositsError) throw depositsError;

    state.members = allMembers || [];
    state.deposits = allDeposits || [];

    // Load deposit requests
    await refreshDepositRequests();

    organizeDataByDate();

    document.getElementById('fromDate').value = '';
    document.getElementById('toDate').value = '';
    document.getElementById('depositDate').value = '';

    refreshMembers();
    refreshDeposits();
    refreshChart();
    refreshDailySummary();
    updateDepositStats();
    updateMemberAutoSaveStatus();

  } catch (error) {
    console.error('Error loading data:', error);
  }
}

function organizeDataByDate() {
  dateWiseData = {};
  
  state.deposits.forEach(deposit => {
    if (!dateWiseData[deposit.date]) {
      dateWiseData[deposit.date] = {
        members: [],
        deposits: []
      };
    }
    dateWiseData[deposit.date].deposits.push(deposit);
  });
  
  state.members.forEach(member => {
    const memberDate = member.created_at ? member.created_at.split('T')[0] : getCurrentLocalDate();
    
    if (!dateWiseData[memberDate]) {
      dateWiseData[memberDate] = {
        members: [],
        deposits: []
      };
    }
    dateWiseData[memberDate].members.push(member);
  });
}

async function refreshMembers() {
  const tb = document.getElementById('memberTable');
  if (!tb) return;

  const keyword = document.getElementById('searchMember')?.value.toLowerCase() || "";
  const statusFilter = document.getElementById('statusFilter')?.value || "";

  const filteredMembers = getFilteredMembers().filter(m => {
    const originalId = extractOriginalId(m.id);
    const matchKeyword = originalId.toLowerCase().includes(keyword) || 
                        m.name.toLowerCase().includes(keyword) ||
                        m.phone.toLowerCase().includes(keyword);
    const status = getMemberStatus(m.last_deposit);
    const matchStatus = !statusFilter || status === statusFilter;
    return matchKeyword && matchStatus;
  });

  tb.innerHTML = '';

  if (filteredMembers.length === 0) {
    const currentDate = getCurrentViewDate();
    const today = getCurrentLocalDate();
    
    if (currentDate === today) {
      tb.innerHTML = `<tr><td colspan="11" class="empty-state">
        <div class="empty-state-icon">üìä</div>
        <div class="empty-state-title">Database Kosong - Hari Ini</div>
        <div class="empty-state-desc">Belum ada data member untuk <strong>${formatDateForDisplay(currentDate)}</strong></div>
        <div class="empty-state-hint">Gunakan "Terima dari Master" untuk import data member</div>
      </td></tr>`;
    } else {
      tb.innerHTML = `<tr><td colspan="11" class="empty-state">
        <div class="empty-state-icon">üìä</div>
        <div class="empty-state-title">Database Kosong</div>
        <div class="empty-state-desc">Tidak ada data member untuk <strong>${formatDateForDisplay(currentDate)}</strong></div>
        <div class="empty-state-hint">Pada tanggal ini belum ada data member yang diimport</div>
      </td></tr>`;
    }
    
    document.getElementById("memberCount").textContent = `Total data: 0 member`;
    updateMemberAutoSaveStatus();
    return;
  }

  filteredMembers.forEach(m => {
    const status = getMemberStatus(m.last_deposit);
    const statusClass = status === 'aktif' ? 'aktif' : status === 'normal' ? 'normal' : 'jarang';
    
    const displayDate = formatDateForDisplay(m.last_deposit);
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${extractOriginalId(m.id)}</td>
      <td>${m.name}</td>
      <td>${m.phone}</td>
      <td>${displayDate}</td>
      <td><span class="badge ${statusClass}">${status}</span></td>
      <td style="text-align:center"><input type="checkbox" ${m.hp_valid ? 'checked' : ''} onchange="toggleMemberField('${m.id}', 'hp_valid', this.checked)"></td>
      <td style="text-align:center"><input type="checkbox" ${!m.hp_valid ? 'checked' : ''} onchange="toggleMemberField('${m.id}', 'hp_valid', !this.checked)"></td>
      <td style="text-align:center"><input type="checkbox" ${m.deposit_valid ? 'checked' : ''} onchange="toggleMemberField('${m.id}', 'deposit_valid', this.checked)"></td>
      <td style="text-align:center"><input type="checkbox" ${!m.deposit_valid ? 'checked' : ''} onchange="toggleMemberField('${m.id}', 'deposit_valid', !this.checked)"></td>
      <td style="text-align:center"><input type="checkbox" ${m.has_response ? 'checked' : ''} onchange="toggleMemberField('${m.id}', 'has_response', this.checked)"></td>
      <td style="text-align:center"><input type="checkbox" ${!m.has_response ? 'checked' : ''} onchange="toggleMemberField('${m.id}', 'has_response', !this.checked)"></td>
    `;
    tb.appendChild(tr);
  });

  document.getElementById("memberCount").textContent = `Total data: ${filteredMembers.length} member`;
  updateMemberAutoSaveStatus();

  const sel = document.getElementById('depositMember');
  sel.innerHTML = '<option value="">-- pilih --</option>';
  state.members.forEach(m => {
    sel.insertAdjacentHTML('beforeend', `<option value="${m.id}">${extractOriginalId(m.id)} - ${m.name}</option>`);
  });
}

async function toggleMemberField(memberId, field, value) {
  try {
    const { error } = await supabase
      .from('members')
      .update({ [field]: value })
      .eq('id', memberId)
      .eq('admin_username', currentAdmin.username);

    if (error) throw error;

    const member = state.members.find(m => m.id === memberId);
    if (member) {
      member[field] = value;
    }

    updateMemberAutoSaveStatus();
  } catch (error) {
    console.error('Error updating member:', error);
  }
}

function refreshDeposits() {
  const tb = document.getElementById('depositTable');
  if (!tb) return;

  const keyword = document.getElementById('searchDeposit')?.value.toLowerCase() || "";
  const currentDate = getCurrentViewDate();

  let filteredDeposits = getFilteredDeposits();
  
  if (keyword) {
    filteredDeposits = filteredDeposits.filter(d => {
      const memberName = d.member_id.startsWith('manual_') ? d.member_name : 
                         (state.members.find(m => m.id === d.member_id)?.name || '');
      return memberName.toLowerCase().includes(keyword) || 
             d.amount.toString().includes(keyword) ||
             d.date.includes(keyword);
    });
  }

  tb.innerHTML = '';

  if (filteredDeposits.length === 0) {
    const today = getCurrentLocalDate();
    
    if (currentDate === today) {
      tb.innerHTML = `<tr><td colspan="5" class="empty-state">
        <div class="empty-state-icon">üí∏</div>
        <div class="empty-state-title">Belum Ada Deposit Hari Ini</div>
        <div class="empty-state-desc">Riwayat deposit untuk <strong>${formatDateForDisplay(currentDate)}</strong> masih kosong</div>
        <div class="empty-state-hint">Gunakan form "Tambah Deposit" untuk menambah data baru</div>
      </td></tr>`;
    } else {
      tb.innerHTML = `<tr><td colspan="5" class="empty-state">
        <div class="empty-state-icon">üí∏</div>
        <div class="empty-state-title">Tidak Ada Deposit</div>
        <div class="empty-state-desc">Tidak ada riwayat deposit pada <strong>${formatDateForDisplay(currentDate)}</strong></div>
        <div class="empty-state-hint">Anda bisa menambah deposit untuk tanggal ini jika ada yang tertinggal</div>
      </td></tr>`;
    }
    return;
  }

  filteredDeposits.forEach(d => {
    const tr = document.createElement('tr');
    const memberDisplay = d.member_id.startsWith('manual_') ? 
      `${d.member_name} (MANUAL)` : 
      `${extractOriginalId(d.member_id)} - ${state.members.find(m => m.id === d.member_id)?.name || '-'}`;
    
    const tipe = d.member_id.startsWith('manual_') ? 'Manual' : 'Database';
    const status = d.approved_by ? '‚úÖ Disetujui' : '‚ûï Manual';
    
    tr.innerHTML = `
      <td>${d.date}</td>
      <td>${memberDisplay}</td>
      <td>${formatCurrency(d.amount)}</td>
      <td><span class="badge ${tipe === 'Database' ? 'aktif' : 'normal'}">${tipe}</span></td>
      <td><span class="badge ${d.approved_by ? 'aktif' : 'normal'}">${status}</span></td>
    `;
    tb.appendChild(tr);
  });
}

function refreshChart() {
  const from = document.getElementById('fromDate').value;
  const to = document.getElementById('toDate').value;

  let filteredDeposits = state.deposits;

  if (from || to) {
    filteredDeposits = state.deposits.filter(d => {
      if (from && d.date < from) return false;
      if (to && d.date > to) return false;
      return true;
    });
  }

  updateDateRangeInfo(from, to);

  let grouped = {};
  let labels = [];
  let data = [];

  if (currentView === 'daily') {
    filteredDeposits.forEach(d => {
      grouped[d.date] = (grouped[d.date] || 0) + d.amount;
    });
    labels = Object.keys(grouped).sort();
    data = labels.map(date => grouped[date]);
  } else if (currentView === 'weekly') {
    filteredDeposits.forEach(d => {
      const date = new Date(d.date);
      const weekStart = new Date(date);
      weekStart.setDate(date.getDate() - date.getDay());
      const weekKey = weekStart.toISOString().slice(0, 10);
      grouped[weekKey] = (grouped[weekKey] || 0) + d.amount;
    });
    labels = Object.keys(grouped).sort();
    data = labels.map(week => grouped[week]);
    labels = labels.map(week => `Minggu ${formatDate(week)}`);
  } else if (currentView === 'monthly') {
    filteredDeposits.forEach(d => {
      const monthKey = d.date.slice(0, 7);
      grouped[monthKey] = (grouped[monthKey] || 0) + d.amount;
    });
    labels = Object.keys(grouped).sort();
    data = labels.map(month => grouped[month]);
    labels = labels.map(month => {
      const [year, monthNum] = month.split('-');
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
      return `${monthNames[parseInt(monthNum) - 1]} ${year}`;
    });
  }

  const ctx = document.getElementById('omsetChart').getContext('2d');
  
  if (chartInstance) {
    chartInstance.destroy();
  }

  if (labels.length === 0) {
    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Tidak ada data'],
        datasets: [{
          label: 'Omset',
          data: [0],
          borderColor: '#d1d5db',
          backgroundColor: 'rgba(209, 213, 219, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false }
        }
      }
    });
  } else {
    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Omset',
          data: data,
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `Rp ${context.raw.toLocaleString('id-ID')}`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return 'Rp ' + value.toLocaleString('id-ID');
              }
            }
          }
        }
      }
    });
  }

  refreshDailySummary();
}

function updateDateRangeInfo(from, to) {
  const infoElement = document.getElementById('dateRangeInfo');
  
  if (!from && !to) {
    const currentDate = getCurrentViewDate();
    const today = getCurrentLocalDate();
    const isToday = currentDate === today;
    
    if (isToday) {
      infoElement.textContent = `üìÖ HARI INI - ${formatDateForDisplay(currentDate)} - Mulai data fresh (${getFilteredDeposits().length} transaksi hari ini) - Tampilan ${currentView === 'daily' ? 'Harian' : currentView === 'weekly' ? 'Mingguan' : 'Bulanan'}`;
      infoElement.style.background = '#f0f9ff';
      infoElement.style.borderColor = '#bae6fd';
      infoElement.style.color = '#0369a1';
    } else {
      infoElement.textContent = `üìÖ MODE VIEW: ${formatDateForDisplay(currentDate)} (${getFilteredDeposits().length} transaksi) - Tampilan ${currentView === 'daily' ? 'Harian' : currentView === 'weekly' ? 'Mingguan' : 'Bulanan'}`;
      infoElement.style.background = '#fef3c7';
      infoElement.style.borderColor = '#fcd34d';
      infoElement.style.color = '#92400e';
    }
  } else if (from && to) {
    const filteredCount = state.deposits.filter(d => d.date >= from && d.date <= to).length;
    infoElement.textContent = `Menampilkan data dari ${formatDate(from)} hingga ${formatDate(to)} (${filteredCount} transaksi) - Tampilan ${currentView === 'daily' ? 'Harian' : currentView === 'weekly' ? 'Mingguan' : 'Bulanan'}`;
    infoElement.style.background = '#fef3c7';
    infoElement.style.borderColor = '#fcd34d';
    infoElement.style.color = '#92400e';
  } else if (from) {
    const filteredCount = state.deposits.filter(d => d.date >= from).length;
    infoElement.textContent = `Menampilkan data sejak ${formatDate(from)} (${filteredCount} transaksi) - Tampilan ${currentView === 'daily' ? 'Harian' : currentView === 'weekly' ? 'Mingguan' : 'Bulanan'}`;
    infoElement.style.background = '#fef3c7';
    infoElement.style.borderColor = '#fcd34d';
    infoElement.style.color = '#92400e';
  } else if (to) {
    const filteredCount = state.deposits.filter(d => d.date <= to).length;
    infoElement.textContent = `Menampilkan data hingga ${formatDate(to)} (${filteredCount} transaksi) - Tampilan ${currentView === 'daily' ? 'Harian' : currentView === 'weekly' ? 'Mingguan' : 'Bulanan'}`;
    infoElement.style.background = '#fef3c7';
    infoElement.style.borderColor = '#fcd34d';
    infoElement.style.color = '#92400e';
  }
}

function refreshDailySummary() {
  const from = document.getElementById('fromDate').value;
  const to = document.getElementById('toDate').value;
  
  let filteredDeposits = state.deposits;
  let summaryText = 'Semua Waktu';
  let depositLabel = 'Total Jumlah Deposit';
  let memberLabel = 'Total Member Deposit';
  let memberDesc = 'Melakukan deposit';

  if (from || to) {
    filteredDeposits = state.deposits.filter(d => {
      if (from && d.date < from) return false;
      if (to && d.date > to) return false;
      return true;
    });
    
    if (from && to) {
      summaryText = `Periode ${formatDate(from)} - ${formatDate(to)}`;
      depositLabel = 'Total Deposit Periode';
      memberLabel = 'Member Deposit Periode';
      memberDesc = 'Melakukan deposit pada periode ini';
    } else if (from) {
      summaryText = `Sejak ${formatDate(from)}`;
      depositLabel = 'Total Deposit Sejak';
      memberLabel = 'Member Deposit Sejak';
      memberDesc = 'Melakukan deposit sejak tanggal tersebut';
    } else if (to) {
      summaryText = `Hingga ${formatDate(to)}`;
      depositLabel = 'Total Deposit Hingga';
      memberLabel = 'Member Deposit Hingga';
      memberDesc = 'Melakukan deposit hingga tanggal tersebut';
    }
  } else {
    const currentDate = getCurrentViewDate();
    const today = getCurrentLocalDate();
    filteredDeposits = getFilteredDeposits();
    
    if (currentDate === today) {
      summaryText = `Hari Ini - ${formatDateForDisplay(currentDate)}`;
      depositLabel = 'Total Deposit Hari Ini';
      memberLabel = 'Member Deposit Hari Ini';
      memberDesc = 'Melakukan deposit hari ini';
    } else {
      summaryText = `Tanggal ${formatDateForDisplay(currentDate)}`;
      depositLabel = 'Total Deposit pada Tanggal';
      memberLabel = 'Member Deposit pada Tanggal';
      memberDesc = 'Melakukan deposit pada tanggal tersebut';
    }
  }

  const totalDeposit = filteredDeposits.reduce((sum, d) => sum + d.amount, 0);
  const uniqueMembers = new Set(filteredDeposits.map(d => d.member_id)).size;

  document.getElementById('totalDepositToday').textContent = formatCurrency(totalDeposit);
  document.getElementById('totalMemberToday').textContent = uniqueMembers + ' Member';
  document.getElementById('summaryDate').textContent = summaryText;
  document.getElementById('totalDepositLabel').textContent = depositLabel;
  document.getElementById('totalMemberLabel').textContent = memberLabel;
  document.getElementById('memberDepositDesc').textContent = memberDesc;
}

function showAllHistoricalData() {
  document.getElementById('fromDate').value = '';
  document.getElementById('toDate').value = '';
  refreshChart();
  refreshMembers();
  refreshDeposits();
}

function searchDepositByDate() {
  const specificDate = prompt('Masukkan tanggal yang ingin dilihat (YYYY-MM-DD):');
  if (specificDate) {
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (!dateRegex.test(specificDate)) {
      alert('Format tanggal tidak valid. Gunakan format YYYY-MM-DD');
      return;
    }
    
    document.getElementById('fromDate').value = specificDate;
    document.getElementById('toDate').value = specificDate;
    refreshChart();
    refreshDeposits();
  }
}

function showMonthlyView() {
  currentView = 'monthly';
  refreshChart();
}

function showWeeklyView() {
  currentView = 'weekly';
  refreshChart();
}

function showDailyView() {
  currentView = 'daily';
  refreshChart();
}

function resetFilter() {
  document.getElementById('fromDate').value = '';
  document.getElementById('toDate').value = '';
  refreshChart();
}

const inputAmt = document.getElementById('depositAmount');
if (inputAmt) {
  inputAmt.addEventListener('input', function(e) {
    let value = this.value.replace(/\D/g, '');
    if (!value) { 
      this.value = ''; 
      return; 
    }
    this.value = new Intl.NumberFormat('id-ID').format(value);
  });
}

function getCleanAmount() {
  let raw = document.getElementById('depositAmount').value;
  return Number(raw.replace(/\./g, ''));
}

document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('fromDate').value = '';
  document.getElementById('toDate').value = '';

  initializeDailySystem();

  const savedUser = localStorage.getItem('currentAdminUser');
  if (savedUser) {
    try {
      currentAdmin = JSON.parse(savedUser);
      openMain(currentAdmin);
    } catch (e) {
      localStorage.removeItem('currentAdminUser');
    }
  }
});
</script>
</body>
</html>